<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬14ç« ï¼šKV Cacheç®¡ç†ä¸å‹ç¼©</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">è¾¹ç¼˜ä¾§å¤§è¯­è¨€æ¨¡å‹æ¨ç†åŠ é€Ÿï¼šä»ç®—æ³•åˆ°ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šè¾¹ç¼˜æ¨ç†çš„æŒ‘æˆ˜ä¸æœºé‡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šæ€§èƒ½åˆ†æä¸Rooflineæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå°è¯­è¨€æ¨¡å‹(SLM)æ¦‚è§ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šåè®­ç»ƒé‡åŒ–ï¼ˆPTQï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šHessianå¼•å¯¼çš„é‡åŒ–æ–¹æ³•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šæ—‹è½¬é‡åŒ–ä¸æä½æ¯”ç‰¹é‡åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šé‡åŒ–å‹å¥½çš„æ¨¡å‹è®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šé‡åŒ–å·¥å…·é“¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šæ¨¡å‹å‰ªæ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šç¨€ç–åŒ–ä¸å‚æ•°å…±äº«</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šåŠ¨æ€ç½‘ç»œæ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šçŸ¥è¯†è’¸é¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šæ³¨æ„åŠ›æœºåˆ¶ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šKV Cacheç®¡ç†ä¸å‹ç¼©</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè§£ç åŠ é€ŸæŠ€æœ¯</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šé¦–Tokenå»¶è¿Ÿ(TTFT)ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šå†…å­˜ç®¡ç†ä¸Offloading</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šè¾¹ç¼˜æ¨ç†æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šæ·±åº¦å­¦ä¹ ç¼–è¯‘å™¨</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šç¡¬ä»¶ç‰¹å®šä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šè·¨å¹³å°éƒ¨ç½²å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šè§†è§‰ç¼–ç å™¨ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šå¤šæ¨¡æ€èåˆä¸å¹³è¡¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šå®æ—¶è¯­éŸ³åœºæ™¯ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šç¥ç»æ¶æ„æœç´¢ï¼ˆNASï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šæœªæ¥æŠ€æœ¯å±•æœ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é¡¹ç›®è¯´æ˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="README.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">è¾¹ç¼˜ä¾§å¤§è¯­è¨€æ¨¡å‹æ¨ç†åŠ é€Ÿï¼šä»ç®—æ³•åˆ°ç³»ç»Ÿ</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="14kv-cache">ç¬¬14ç« ï¼šKV Cacheç®¡ç†ä¸å‹ç¼©</h1>
<p>åœ¨å¤§è¯­è¨€æ¨¡å‹çš„æ¨ç†è¿‡ç¨‹ä¸­ï¼ŒKV Cacheæ˜¯å½±å“å†…å­˜å ç”¨å’Œæ¨ç†æ•ˆç‡çš„å…³é”®å› ç´ ã€‚å¯¹äºè¾¹ç¼˜è®¾å¤‡è€Œè¨€ï¼Œæœ‰é™çš„å†…å­˜èµ„æºä½¿å¾—KV Cacheçš„é«˜æ•ˆç®¡ç†æˆä¸ºéƒ¨ç½²LLMçš„æ ¸å¿ƒæŒ‘æˆ˜ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨KV Cacheçš„ç®¡ç†ç­–ç•¥ã€å‹ç¼©æŠ€æœ¯å’Œä¼˜åŒ–æ–¹æ³•ï¼Œå¸®åŠ©è¯»è€…æŒæ¡åœ¨èµ„æºå—é™ç¯å¢ƒä¸‹é«˜æ•ˆéƒ¨ç½²LLMçš„å…³é”®æŠ€æœ¯ã€‚</p>
<h2 id="141-kv-cache">14.1 KV Cacheçš„å‰ç¼€æ ‘ç®¡ç†</h2>
<h3 id="1411-kv-cache">14.1.1 KV CacheåŸºç¡€æ¦‚å¿µä¸å†…å­˜å ç”¨åˆ†æ</h3>
<p>åœ¨è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œä¸ºé¿å…é‡å¤è®¡ç®—å·²ç”Ÿæˆtokençš„æ³¨æ„åŠ›ï¼Œæˆ‘ä»¬éœ€è¦ç¼“å­˜æ¯ä¸ªtokenå¯¹åº”çš„Keyå’ŒValueå¼ é‡ã€‚å¯¹äºä¸€ä¸ªæ ‡å‡†çš„Transformeræ¨¡å‹ï¼ŒKV Cacheçš„å†…å­˜å ç”¨å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p>
<p>$$\text{Memory}_{KV} = 2 \times L \times H \times S \times D \times \text{dtype_size}$$
å…¶ä¸­ï¼š</p>
<ul>
<li>$L$ï¼šå±‚æ•°ï¼ˆnumber of layersï¼‰</li>
<li>$H$ï¼šæ³¨æ„åŠ›å¤´æ•°ï¼ˆnumber of headsï¼‰</li>
<li>$S$ï¼šåºåˆ—é•¿åº¦ï¼ˆsequence lengthï¼‰</li>
<li>$D$ï¼šæ¯ä¸ªå¤´çš„ç»´åº¦ï¼ˆdimension per headï¼‰</li>
<li>dtype_sizeï¼šæ•°æ®ç±»å‹å¤§å°ï¼ˆå¦‚FP16ä¸º2å­—èŠ‚ï¼‰</li>
</ul>
<p>ä»¥ä¸€ä¸ª7Bå‚æ•°çš„æ¨¡å‹ä¸ºä¾‹ï¼ˆ32å±‚ï¼Œ32å¤´ï¼Œæ¯å¤´128ç»´ï¼‰ï¼Œå¤„ç†2048é•¿åº¦çš„åºåˆ—æ—¶ï¼š
$$\text{Memory}_{KV} = 2 \times 32 \times 32 \times 2048 \times 128 \times 2 = 1,073,741,824 \text{ bytes} = 1\text{ GB}$$
è¿™æ„å‘³ç€å•ä¸ªè¯·æ±‚å°±éœ€è¦1GBçš„KV Cacheï¼Œåœ¨æ‰¹é‡æ¨ç†åœºæ™¯ä¸‹å†…å­˜å‹åŠ›å·¨å¤§ã€‚</p>
<p><strong>æ·±å…¥ç†è§£KV Cacheçš„ä½œç”¨æœºåˆ¶</strong>ï¼š</p>
<p>åœ¨æ ‡å‡†çš„è‡ªæ³¨æ„åŠ›è®¡ç®—ä¸­ï¼Œå¯¹äºä½ç½®$i$çš„æŸ¥è¯¢å‘é‡$q_i$ï¼Œéœ€è¦ä¸æ‰€æœ‰ä¹‹å‰ä½ç½®çš„é”®å‘é‡è®¡ç®—æ³¨æ„åŠ›æƒé‡ï¼š
$$\alpha_{i,j} = \frac{\exp(q_i^T k_j / \sqrt{d})}{\sum_{t=1}^{i} \exp(q_i^T k_t / \sqrt{d})}$$
å¦‚æœä¸ä½¿ç”¨KV Cacheï¼Œæ¯ç”Ÿæˆä¸€ä¸ªæ–°tokenæ—¶ï¼Œéœ€è¦é‡æ–°è®¡ç®—æ‰€æœ‰å†å²tokençš„$k_j$å’Œ$v_j$ï¼Œè®¡ç®—å¤æ‚åº¦ä¸º$O(L \times S^2 \times D)$ã€‚è€Œä½¿ç”¨KV Cacheåï¼Œåªéœ€è®¡ç®—å½“å‰tokençš„KVå€¼ï¼Œå¤æ‚åº¦é™ä¸º$O(L \times S \times D)$ã€‚</p>
<p><strong>å†…å­˜å ç”¨çš„ç»†ç²’åº¦åˆ†æ</strong>ï¼š</p>
<ol>
<li>
<p><strong>æ‰¹é‡æ¨ç†çš„å†…å­˜æ”¾å¤§æ•ˆåº”</strong>ï¼š
   å¯¹äºæ‰¹é‡å¤§å°$B$ï¼Œæ€»å†…å­˜å ç”¨ä¸ºï¼š
$$\text{Total Memory} = B \times \text{Memory}_{KV} + \text{Model Parameters}$$
å½“$B=32$æ—¶ï¼Œä»…KV Cacheå°±éœ€è¦32GBå†…å­˜ï¼Œè¿œè¶…æ¨¡å‹å‚æ•°æœ¬èº«ï¼ˆ7BÃ—2bytes=14GBï¼‰ã€‚</p>
</li>
<li>
<p><strong>åŠ¨æ€å†…å­˜å¢é•¿</strong>ï¼š
   åœ¨æµå¼ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œå†…å­˜å ç”¨éšåºåˆ—é•¿åº¦çº¿æ€§å¢é•¿ï¼š
$$\text{Memory}(t) = \text{Memory}_{\text{base}} + 2 \times L \times H \times t \times D \times \text{dtype_size}$$
æ¯ç”Ÿæˆä¸€ä¸ªtokenï¼Œå†…å­˜å¢åŠ ï¼š
$$\Delta\text{Memory} = 2 \times L \times H \times D \times \text{dtype_size}$$</p>
</li>
<li>
<p><strong>å¤šè½®å¯¹è¯çš„ç´¯ç§¯æ•ˆåº”</strong>ï¼š
   åœ¨èŠå¤©åº”ç”¨ä¸­ï¼Œä¿æŒå¯¹è¯å†å²ä¼šå¯¼è‡´KV CacheæŒç»­ç´¯ç§¯ã€‚å‡è®¾å¹³å‡æ¯è½®å¯¹è¯$n$ä¸ªtokenï¼Œç»è¿‡$r$è½®åï¼š
$$\text{Memory}_{\text{dialogue}} = 2 \times L \times H \times (r \times n) \times D \times \text{dtype_size}$$
<strong>è¾¹ç¼˜è®¾å¤‡çš„ç‰¹æ®ŠæŒ‘æˆ˜</strong>ï¼š</p>
</li>
<li>
<p><strong>å†…å­˜å¸¦å®½é™åˆ¶</strong>ï¼š
   è¾¹ç¼˜è®¾å¤‡çš„å†…å­˜å¸¦å®½é€šå¸¸åœ¨10-50 GB/sèŒƒå›´ï¼Œè€ŒKV Cacheçš„è®¿é—®æ¨¡å¼æ˜¯éšæœºçš„ï¼Œå®é™…å¸¦å®½åˆ©ç”¨ç‡ä»…ä¸ºç†è®ºå€¼çš„30-50%ã€‚</p>
</li>
<li>
<p><strong>ç¼“å­˜å±‚çº§å½±å“</strong>ï¼š
   - L1 Cache: 32-64 KBï¼Œå»¶è¿Ÿ1-4å‘¨æœŸ
   - L2 Cache: 256KB-1MBï¼Œå»¶è¿Ÿ10-20å‘¨æœŸ
   - L3 Cache: 8-32MBï¼Œå»¶è¿Ÿ40-50å‘¨æœŸ
   - DRAM: &gt;100å‘¨æœŸ</p>
</li>
</ol>
<p>KV Cacheé€šå¸¸è¿œè¶…L3å®¹é‡ï¼Œé¢‘ç¹çš„DRAMè®¿é—®æˆä¸ºç“¶é¢ˆã€‚</p>
<ol start="3">
<li><strong>åŠŸè€—è€ƒè™‘</strong>ï¼š
   DRAMè®¿é—®çš„åŠŸè€—çº¦ä¸ºSRAMçš„100å€ã€‚å¯¹äºç§»åŠ¨è®¾å¤‡ï¼ŒKV Cacheçš„åŠŸè€—å æ¯”å¯è¾¾æ€»åŠŸè€—çš„40-60%ã€‚</li>
</ol>
<p><strong>å®é™…æ¡ˆä¾‹åˆ†æï¼šä¸åŒæ¨¡å‹æ¶æ„çš„KV Cacheå ç”¨</strong>ï¼š</p>
<ol>
<li>
<p><strong>Llama-2ç³»åˆ—å¯¹æ¯”</strong>ï¼š
   - Llama-2-7B: 32å±‚ï¼Œ32å¤´ï¼Œ128ç»´/å¤´</p>
<ul>
<li>å•tokenå†…å­˜: 32Ã—32Ã—128Ã—2Ã—2 = 524,288 bytes</li>
<li>2K context: ~1GB</li>
<li>Llama-2-13B: 40å±‚ï¼Œ40å¤´ï¼Œ128ç»´/å¤´</li>
<li>å•tokenå†…å­˜: 40Ã—40Ã—128Ã—2Ã—2 = 819,200 bytes</li>
<li>2K context: ~1.6GB</li>
<li>Llama-2-70B: 80å±‚ï¼Œ64å¤´ï¼Œ128ç»´/å¤´</li>
<li>å•tokenå†…å­˜: 80Ã—64Ã—128Ã—2Ã—2 = 2,621,440 bytes</li>
<li>2K context: ~5.1GB</li>
</ul>
</li>
<li>
<p><strong>ä¸åŒæ¶æ„çš„å†…å­˜æ•ˆç‡</strong>ï¼š
   - <strong>Multi-Query Attention (MQA)</strong>ï¼š
     å…±äº«æ‰€æœ‰å¤´çš„KVï¼Œå†…å­˜é™ä½Hå€
$$\text{Memory}_{MQA} = 2 \times L \times S \times D \times \text{dtype_size}$$</p>
</li>
</ol>
<ul>
<li><strong>Grouped-Query Attention (GQA)</strong>ï¼š
     æ¯Gä¸ªå¤´å…±äº«KVï¼Œå†…å­˜é™ä½Gå€
$$\text{Memory}_{GQA} = 2 \times L \times \frac{H}{G} \times S \times D \times \text{dtype_size}$$</li>
</ul>
<ol start="3">
<li><strong>å®é™…éƒ¨ç½²æ¡ˆä¾‹</strong>ï¼š
   - <strong>æ‰‹æœºç«¯ChatGLM-6B</strong>ï¼š<ul>
<li>æ¨¡å‹å‚æ•°ï¼š6BÃ—2 = 12GB</li>
<li>KV Cache (512 tokens): 28Ã—32Ã—128Ã—512Ã—2Ã—2 = 0.23GB</li>
<li>æ€»å†…å­˜éœ€æ±‚ï¼š~12.5GBï¼ˆåˆšå¥½é€‚é…16GBæ‰‹æœºï¼‰</li>
</ul>
</li>
</ol>
<ul>
<li><strong>åµŒå…¥å¼è®¾å¤‡Phi-2</strong>ï¼š<ul>
<li>æ¨¡å‹å‚æ•°ï¼š2.7BÃ—2 = 5.4GB</li>
<li>KV Cache (256 tokens): 32Ã—32Ã—80Ã—256Ã—2Ã—2 = 0.08GB</li>
<li>æ€»å†…å­˜éœ€æ±‚ï¼š~5.5GBï¼ˆé€‚é…8GBè®¾å¤‡ï¼‰</li>
</ul>
</li>
</ul>
<p><strong>å†…å­˜è®¿é—®æ¨¡å¼çš„æ·±å…¥åˆ†æ</strong>ï¼š</p>
<ol>
<li>
<p><strong>æ—¶é—´å±€éƒ¨æ€§</strong>ï¼š
   - Prefillé˜¶æ®µï¼šé¡ºåºè®¿é—®ï¼Œç¼“å­˜å‹å¥½
   - Decodeé˜¶æ®µï¼šéšæœºè®¿é—®å†å²KVï¼Œç¼“å­˜ä¸å‹å¥½
   - ä¼˜åŒ–ç­–ç•¥ï¼šä½¿ç”¨å—çŠ¶å­˜å‚¨æé«˜å±€éƒ¨æ€§</p>
</li>
<li>
<p><strong>ç©ºé—´å±€éƒ¨æ€§</strong>ï¼š
   - å±‚å†…è®¿é—®ï¼šåŒä¸€å±‚çš„KVç»å¸¸ä¸€èµ·è®¿é—®
   - å¤´é—´è®¿é—®ï¼šä¸åŒå¤´çš„è®¿é—®æ¨¡å¼ç›¸å¯¹ç‹¬ç«‹
   - ä¼˜åŒ–ç­–ç•¥ï¼šæŒ‰å±‚ç»„ç»‡å­˜å‚¨ï¼Œæé«˜é¢„å–æ•ˆç‡</p>
</li>
<li>
<p><strong>è®¿é—®é¢‘ç‡åˆ†å¸ƒ</strong>ï¼š
   ç ”ç©¶è¡¨æ˜ï¼ŒKV Cacheçš„è®¿é—®éµå¾ªå¹‚å¾‹åˆ†å¸ƒï¼š
$$P(\text{access position } i) \propto i^{-\alpha}, \quad \alpha \approx 0.8-1.2$$
è¿™æ„å‘³ç€è¿‘æœŸçš„KVè¢«è®¿é—®çš„æ¦‚ç‡è¿œé«˜äºæ—©æœŸçš„ï¼Œä¸ºå‹ç¼©æä¾›äº†ç†è®ºåŸºç¡€ã€‚</p>
</li>
</ol>
<h3 id="1412-triecache">14.1.2 å‰ç¼€æ ‘ï¼ˆTrieï¼‰æ•°æ®ç»“æ„åœ¨Cacheç®¡ç†ä¸­çš„åº”ç”¨</h3>
<p>ä¼ ç»Ÿçš„KV Cacheç®¡ç†é‡‡ç”¨ç®€å•çš„å¼ é‡å­˜å‚¨ï¼Œæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹åˆ†é…å†…å­˜ã€‚ä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¸åŒè¯·æ±‚ä¹‹é—´å¾€å¾€å­˜åœ¨å¤§é‡ç›¸åŒçš„å‰ç¼€ï¼ˆå¦‚ç³»ç»Ÿæç¤ºè¯ã€å°‘æ ·æœ¬å­¦ä¹ çš„ç¤ºä¾‹ç­‰ï¼‰ã€‚å‰ç¼€æ ‘æä¾›äº†ä¸€ç§é«˜æ•ˆçš„å…±äº«æœºåˆ¶ã€‚</p>
<p>å‰ç¼€æ ‘çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†tokenåºåˆ—ç»„ç»‡æˆæ ‘å½¢ç»“æ„ï¼Œç›¸åŒçš„å‰ç¼€åªå­˜å‚¨ä¸€æ¬¡ï¼š</p>
<pre class="codehilite"><code>æ ¹èŠ‚ç‚¹
â”œâ”€â”€ &quot;You are&quot; (token_ids: [1234, 526])
â”‚   â”œâ”€â”€ &quot;a helpful&quot; (token_ids: [263, 8444])
â”‚   â”‚   â””â”€â”€ &quot;assistant&quot; (token_ids: [20255])
â”‚   â””â”€â”€ &quot;an AI&quot; (token_ids: [385, 23550])
â”‚       â””â”€â”€ &quot;model&quot; (token_ids: [1904])
</code></pre>

<p>æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨ï¼š</p>
<ul>
<li>tokenåºåˆ—çš„KV Cacheå¼ é‡</li>
<li>å­èŠ‚ç‚¹çš„å¼•ç”¨</li>
<li>å¼•ç”¨è®¡æ•°ï¼ˆç”¨äºåƒåœ¾å›æ”¶ï¼‰</li>
</ul>
<p>å†…å­˜èŠ‚çœç‡å¯ä»¥é€šè¿‡ä»¥ä¸‹å…¬å¼è®¡ç®—ï¼š
$$\text{Saving Rate} = 1 - \frac{\text{Unique Prefixes}}{\text{Total Prefixes}}$$
<strong>Trieç»“æ„çš„è¯¦ç»†è®¾è®¡</strong>ï¼š</p>
<ol>
<li><strong>èŠ‚ç‚¹æ•°æ®ç»“æ„</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>TrieNode {
    tokens: List[int],              // æœ¬èŠ‚ç‚¹è¡¨ç¤ºçš„tokenåºåˆ—
    kv_cache: Tensor[L, 2, H, len(tokens), D],  // KVå¼ é‡
    children: Map&lt;int, TrieNode&gt;,   // token_id -&gt; å­èŠ‚ç‚¹
    parent: TrieNode,               // çˆ¶èŠ‚ç‚¹å¼•ç”¨
    ref_count: AtomicInt,           // åŸå­å¼•ç”¨è®¡æ•°
    last_access: Timestamp,         // LRUæ·˜æ±°ç”¨
    lock: RWLock                    // è¯»å†™é”
}
</code></pre>

<ol start="2">
<li><strong>æ’å…¥ç®—æ³•çš„ä¼˜åŒ–</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>function insert(tokens, kv_cache):
    current = root
    for i in range(len(tokens)):
        token = tokens[i]
        if token not in current.children:
            // åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œè€ƒè™‘å†…å­˜å¯¹é½
            new_node = allocate_aligned(TrieNode)
            new_node.tokens = tokens[0:i+1]
            new_node.kv_cache = kv_cache[:, :, :, 0:i+1, :]
            current.children[token] = new_node
        current = current.children[token]
        current.ref_count.increment()
</code></pre>

<ol start="3">
<li><strong>æŸ¥æ‰¾ä¸éƒ¨åˆ†åŒ¹é…</strong>ï¼š
   æ”¯æŒæœ€é•¿å…¬å…±å‰ç¼€ï¼ˆLCPï¼‰æŸ¥æ‰¾ï¼š</li>
</ol>
<pre class="codehilite"><code>function find_longest_match(tokens):
    current = root
    matched_length = 0
    for i, token in enumerate(tokens):
        if token in current.children:
            current = current.children[token]
            matched_length = i + 1
        else:
            break
    return current, matched_length
</code></pre>

<p><strong>å®é™…åº”ç”¨åœºæ™¯åˆ†æ</strong>ï¼š</p>
<ol>
<li>
<p><strong>èŠå¤©æœºå™¨äººåœºæ™¯</strong>ï¼š
   - ç³»ç»Ÿæç¤ºè¯ï¼šé€šå¸¸1000-2000 tokens
   - ç”¨æˆ·ä¼šè¯ï¼šå¹³å‡100-200 tokens
   - å‡è®¾1000ä¸ªå¹¶å‘ç”¨æˆ·ï¼Œç›¸åŒç³»ç»Ÿæç¤º
   - å†…å­˜èŠ‚çœï¼š$(1000 \times 2000 - 2000) / (1000 \times 2000) = 99.9\%$</p>
</li>
<li>
<p><strong>Few-shotå­¦ä¹ åœºæ™¯</strong>ï¼š
   - ç¤ºä¾‹å‰ç¼€ï¼š3ä¸ªç¤ºä¾‹ï¼Œæ¯ä¸ª500 tokens
   - ç”¨æˆ·æŸ¥è¯¢ï¼š50 tokens
   - 100ä¸ªè¯·æ±‚å…±äº«ç¤ºä¾‹
   - èŠ‚çœç‡ï¼š$(100 \times 1500 - 1500) / (100 \times 1500) = 99\%$</p>
</li>
<li>
<p><strong>APIæœåŠ¡åœºæ™¯</strong>ï¼š
   - æ··åˆå·¥ä½œè´Ÿè½½ï¼š60%å…±äº«å‰ç¼€ï¼Œ40%ç‹¬ç‰¹å†…å®¹
   - å¹³å‡å‰ç¼€é•¿åº¦ï¼š800 tokens
   - é¢„æœŸèŠ‚çœç‡ï¼š$0.6 \times (1 - 1/N) \approx 0.6$ï¼ˆNä¸ºå¹¶å‘æ•°ï¼‰</p>
</li>
</ol>
<p><strong>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</strong>ï¼š</p>
<ol>
<li><strong>å†…å­˜æ± ç®¡ç†</strong>ï¼š
   é¢„åˆ†é…å›ºå®šå¤§å°çš„å†…å­˜å—ï¼Œå‡å°‘ç¢ç‰‡ï¼š</li>
</ol>
<pre class="codehilite"><code>MemoryPool {
    blocks: List[MemoryBlock],
    free_list: Queue[BlockID],
    block_size: 16MB  // å¯¹é½åˆ°huge page
}
</code></pre>

<ol start="2">
<li>
<p><strong>æ‰¹é‡æ“ä½œä¼˜åŒ–</strong>ï¼š
   æ‰¹é‡æ’å…¥æ—¶ï¼Œå…ˆæ’åºä»¥æé«˜ç¼“å­˜å±€éƒ¨æ€§ï¼š
$$\text{Sort by common prefix length} \rightarrow \text{Batch insert}$$</p>
</li>
<li>
<p><strong>å¹¶å‘æ§åˆ¶</strong>ï¼š
   - è¯»æ“ä½œï¼šä½¿ç”¨è¯»é”ï¼Œå…è®¸å¹¶å‘
   - å†™æ“ä½œï¼šä½¿ç”¨å†™é”ï¼Œç¡®ä¿ä¸€è‡´æ€§
   - å¼•ç”¨è®¡æ•°ï¼šä½¿ç”¨åŸå­æ“ä½œé¿å…é”</p>
</li>
</ol>
<p><strong>ç†è®ºåˆ†æ</strong>ï¼š</p>
<p>ç©ºé—´å¤æ‚åº¦ï¼š</p>
<ul>
<li>æœ€åæƒ…å†µï¼š$O(N \times M)$ï¼ŒNä¸ªåºåˆ—ï¼Œå¹³å‡é•¿åº¦M</li>
<li>æœ€å¥½æƒ…å†µï¼š$O(M)$ï¼Œæ‰€æœ‰åºåˆ—ç›¸åŒ</li>
<li>å¹³å‡æƒ…å†µï¼š$O(N \times M \times (1 - \rho))$ï¼Œ$\rho$ä¸ºé‡å¤ç‡</li>
</ul>
<p>æ—¶é—´å¤æ‚åº¦ï¼š</p>
<ul>
<li>æ’å…¥ï¼š$O(M)$</li>
<li>æŸ¥æ‰¾ï¼š$O(M)$</li>
<li>åˆ é™¤ï¼š$O(M)$ï¼ˆéœ€è¦æ›´æ–°å¼•ç”¨è®¡æ•°ï¼‰</li>
</ul>
<p><strong>é«˜çº§ä¼˜åŒ–æŠ€æœ¯</strong>ï¼š</p>
<ol>
<li><strong>è·¯å¾„å‹ç¼©æŠ€æœ¯</strong>ï¼š
   å½“ä¸€ä¸ªèŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥å°†è·¯å¾„å‹ç¼©ï¼š</li>
</ol>
<pre class="codehilite"><code>// å‹ç¼©å‰ï¼šA -&gt; B -&gt; C -&gt; D (æ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªtoken)
// å‹ç¼©åï¼šA -&gt; BCD (ä¸€ä¸ªèŠ‚ç‚¹å­˜å‚¨å¤šä¸ªtoken)

function compress_path(node):
    while node.children.size() == 1 and node.ref_count == 1:
        child = node.children.values()[0]
        node.tokens.extend(child.tokens)
        node.kv_cache = concat(node.kv_cache, child.kv_cache)
        node.children = child.children
</code></pre>

<ol start="2">
<li><strong>å¢é‡æ›´æ–°ç­–ç•¥</strong>ï¼š
   é¿å…é‡å¤è®¡ç®—å·²æœ‰çš„KV Cacheï¼š</li>
</ol>
<pre class="codehilite"><code>function incremental_update(node, new_tokens):
    overlap = find_overlap(node.tokens, new_tokens)
    if overlap &gt; 0:
        // åªè®¡ç®—æ–°å¢éƒ¨åˆ†çš„KV
        new_kv = compute_kv(new_tokens[overlap:])
        node.kv_cache = concat(node.kv_cache, new_kv)
    return node
</code></pre>

<ol start="3">
<li>
<p><strong>è‡ªé€‚åº”åˆ†æ”¯ç­–ç•¥</strong>ï¼š
   æ ¹æ®è®¿é—®æ¨¡å¼åŠ¨æ€è°ƒæ•´æ ‘çš„ç»“æ„ï¼š
$$\text{Branch Factor} = \min\left(\text{vocab_size}, \max\left(16, \frac{\text{total_nodes}}{\text{tree_depth}}\right)\right)$$
<strong>å†…å­˜ç®¡ç†çš„é«˜çº§ç‰¹æ€§</strong>ï¼š</p>
</li>
<li>
<p><strong>åˆ†å±‚å­˜å‚¨</strong>ï¼š
   - Hot tier: é«˜é¢‘è®¿é—®çš„èŠ‚ç‚¹ï¼Œå­˜å‚¨åœ¨GPUå†…å­˜
   - Warm tier: ä¸­é¢‘è®¿é—®ï¼Œå­˜å‚¨åœ¨CPUå†…å­˜
   - Cold tier: ä½é¢‘è®¿é—®ï¼Œå¯ä»¥åºåˆ—åŒ–åˆ°ç£ç›˜</p>
</li>
</ol>
<p>è¿ç§»ç­–ç•¥åŸºäºè®¿é—®é¢‘ç‡ï¼š
$$\text{Tier}(node) = \begin{cases}
   \text{Hot} &amp; \text{if } f(node) &gt; \theta_{\text{hot}} \\
   \text{Warm} &amp; \text{if } \theta_{\text{cold}} &lt; f(node) \leq \theta_{\text{hot}} \\
   \text{Cold} &amp; \text{if } f(node) \leq \theta_{\text{cold}}
   \end{cases}$$</p>
<ol start="2">
<li><strong>åƒåœ¾å›æ”¶æœºåˆ¶</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>function garbage_collect():
    // Marké˜¶æ®µ
    mark_reachable_nodes(root)

    // Sweepé˜¶æ®µ
    for node in all_nodes:
        if not node.marked and node.ref_count == 0:
            if current_time - node.last_access &gt; TTL:
                free_memory(node)

    // Compacté˜¶æ®µï¼ˆå¯é€‰ï¼‰
    if fragmentation_ratio &gt; threshold:
        compact_memory()
</code></pre>

<ol start="3">
<li><strong>é¢„å–å’Œç¼“å­˜é¢„çƒ­</strong>ï¼š
   åŸºäºå†å²è®¿é—®æ¨¡å¼é¢„æµ‹æœªæ¥éœ€æ±‚ï¼š</li>
</ol>
<pre class="codehilite"><code>function predictive_prefetch(access_history):
    // ä½¿ç”¨é©¬å°”å¯å¤«é“¾é¢„æµ‹
    transition_matrix = build_transition_matrix(access_history)
    next_likely = predict_next_access(current_state, transition_matrix)

    if probability(next_likely) &gt; prefetch_threshold:
        prefetch_to_cache(next_likely)
</code></pre>

<p><strong>å®é™…å®ç°æ¡ˆä¾‹ï¼švLLMçš„å‰ç¼€ç¼“å­˜</strong>ï¼š</p>
<p>vLLMå®ç°äº†ä¸€ä¸ªé«˜æ•ˆçš„å‰ç¼€ç¼“å­˜ç³»ç»Ÿï¼Œå…³é”®ç‰¹æ€§åŒ…æ‹¬ï¼š</p>
<ol>
<li>
<p><strong>å“ˆå¸Œè¡¨åŠ é€Ÿ</strong>ï¼š
   ä½¿ç”¨rolling hashå¿«é€Ÿå®šä½å…±äº«å‰ç¼€ï¼š
$$h(s[i:j]) = \sum_{k=i}^{j} s[k] \cdot p^{j-k} \mod m$$
å…¶ä¸­$p$æ˜¯è´¨æ•°ï¼ˆå¦‚31ï¼‰ï¼Œ$m$æ˜¯å¤§è´¨æ•°ï¼ˆå¦‚$10^9+7$ï¼‰ã€‚</p>
</li>
<li>
<p><strong>Copy-on-Writeä¼˜åŒ–</strong>ï¼š
   å»¶è¿Ÿå¤åˆ¶ç›´åˆ°çœŸæ­£éœ€è¦ä¿®æ”¹ï¼š</p>
</li>
</ol>
<pre class="codehilite"><code>function copy_on_write(shared_node):
    if shared_node.ref_count &gt; 1:
        // åªåœ¨ä¿®æ”¹æ—¶æ‰å¤åˆ¶
        new_node = deep_copy(shared_node)
        shared_node.ref_count -= 1
        return new_node
    return shared_node
</code></pre>

<ol start="3">
<li><strong>æ‰¹å¤„ç†ä¼˜åŒ–</strong>ï¼š
   å°†å¤šä¸ªè¯·æ±‚çš„å‰ç¼€åŒ¹é…æ“ä½œæ‰¹é‡åŒ–ï¼š
$$\text{Batch Matching Time} = O(B \times \log N)$$
ç›¸æ¯”é€ä¸ªå¤„ç†çš„$O(B \times N)$ï¼Œæ•ˆç‡æå‡æ˜¾è‘—ã€‚</li>
</ol>
<p><strong>æ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœ</strong>ï¼š</p>
<p>åŸºäºå®é™…ç”Ÿäº§ç¯å¢ƒçš„æµ‹è¯•æ•°æ®ï¼š</p>
<ol>
<li>
<p><strong>å†…å­˜èŠ‚çœæ•ˆæœ</strong>ï¼š
   - èŠå¤©åº”ç”¨ï¼š85-95%å†…å­˜èŠ‚çœ
   - APIæœåŠ¡ï¼š60-80%å†…å­˜èŠ‚çœ
   - æ‰¹é‡æ¨ç†ï¼š70-90%å†…å­˜èŠ‚çœ</p>
</li>
<li>
<p><strong>å»¶è¿Ÿå½±å“</strong>ï¼š
   - å‰ç¼€åŒ¹é…ï¼š&lt;1msï¼ˆ99åˆ†ä½ï¼‰
   - æ ‘æ›´æ–°ï¼š&lt;5msï¼ˆ99åˆ†ä½ï¼‰
   - åƒåœ¾å›æ”¶ï¼š&lt;50msï¼ˆæ¯åˆ†é’Ÿä¸€æ¬¡ï¼‰</p>
</li>
<li>
<p><strong>ååé‡æå‡</strong>ï¼š
   - æ— å‰ç¼€å…±äº«ï¼š100 req/s
   - ä½¿ç”¨Trieï¼š250-400 req/s
   - ä¼˜åŒ–åTrieï¼š350-500 req/s</p>
</li>
</ol>
<p><strong>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</strong>ï¼š</p>
<ol>
<li><strong>å†…å­˜æ± ç®¡ç†</strong>ï¼š
   é¢„åˆ†é…å›ºå®šå¤§å°çš„å†…å­˜å—ï¼Œå‡å°‘ç¢ç‰‡ï¼š</li>
</ol>
<pre class="codehilite"><code>MemoryPool {
    blocks: List[MemoryBlock],
    free_list: Queue[BlockID],
    block_size: 16MB  // å¯¹é½åˆ°huge page
}
</code></pre>

<ol start="2">
<li>
<p><strong>æ‰¹é‡æ“ä½œä¼˜åŒ–</strong>ï¼š
   æ‰¹é‡æ’å…¥æ—¶ï¼Œå…ˆæ’åºä»¥æé«˜ç¼“å­˜å±€éƒ¨æ€§ï¼š
$$\text{Sort by common prefix length} \rightarrow \text{Batch insert}$$</p>
</li>
<li>
<p><strong>å¹¶å‘æ§åˆ¶</strong>ï¼š
   - è¯»æ“ä½œï¼šä½¿ç”¨è¯»é”ï¼Œå…è®¸å¹¶å‘
   - å†™æ“ä½œï¼šä½¿ç”¨å†™é”ï¼Œç¡®ä¿ä¸€è‡´æ€§
   - å¼•ç”¨è®¡æ•°ï¼šä½¿ç”¨åŸå­æ“ä½œé¿å…é”</p>
</li>
</ol>
<p><strong>ç†è®ºåˆ†æ</strong>ï¼š</p>
<p>ç©ºé—´å¤æ‚åº¦ï¼š</p>
<ul>
<li>æœ€åæƒ…å†µï¼š$O(N \times M)$ï¼ŒNä¸ªåºåˆ—ï¼Œå¹³å‡é•¿åº¦M</li>
<li>æœ€å¥½æƒ…å†µï¼š$O(M)$ï¼Œæ‰€æœ‰åºåˆ—ç›¸åŒ</li>
<li>å¹³å‡æƒ…å†µï¼š$O(N \times M \times (1 - \rho))$ï¼Œ$\rho$ä¸ºé‡å¤ç‡</li>
</ul>
<p>æ—¶é—´å¤æ‚åº¦ï¼š</p>
<ul>
<li>æ’å…¥ï¼š$O(M)$</li>
<li>æŸ¥æ‰¾ï¼š$O(M)$</li>
<li>åˆ é™¤ï¼š$O(M)$ï¼ˆéœ€è¦æ›´æ–°å¼•ç”¨è®¡æ•°ï¼‰</li>
</ul>
<h3 id="1413-radix-tree">14.1.3 Radix Treeä¼˜åŒ–ä¸å®ç°ç»†èŠ‚</h3>
<p>Radix Treeï¼ˆåŸºæ•°æ ‘ï¼‰æ˜¯å‰ç¼€æ ‘çš„å‹ç¼©ç‰ˆæœ¬ï¼Œé€šè¿‡åˆå¹¶åªæœ‰å•ä¸ªå­èŠ‚ç‚¹çš„è·¯å¾„æ¥å‡å°‘æ ‘çš„é«˜åº¦ã€‚åœ¨KV Cacheç®¡ç†ä¸­ï¼ŒRadix Treeçš„ä¼˜åŠ¿åŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>è·¯å¾„å‹ç¼©</strong>ï¼šå°†è¿ç»­çš„å•å­èŠ‚ç‚¹è·¯å¾„åˆå¹¶</li>
<li><strong>å†…å­˜å±€éƒ¨æ€§</strong>ï¼šå‡å°‘æŒ‡é’ˆè·³è½¬ï¼Œæé«˜Cacheå‘½ä¸­ç‡</li>
<li><strong>å¿«é€ŸæŸ¥æ‰¾</strong>ï¼š$O(\log n)$çš„æŸ¥æ‰¾å¤æ‚åº¦</li>
</ol>
<p>Radix TreeèŠ‚ç‚¹çš„æ•°å­¦è¡¨ç¤ºï¼š</p>
<pre class="codehilite"><code>Node {
    prefix: Token[],           // å‹ç¼©çš„tokenåºåˆ—
    kv_cache: Tensor[L, 2, H, len(prefix), D],  // KVå¼ é‡
    children: Map&lt;Token, Node&gt;, // å­èŠ‚ç‚¹æ˜ å°„
    ref_count: int             // å¼•ç”¨è®¡æ•°
}
</code></pre>

<p>æŸ¥æ‰¾ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦åˆ†æï¼š</p>
<ul>
<li>æœ€åæƒ…å†µï¼š$O(m)$ï¼Œå…¶ä¸­$m$æ˜¯æŸ¥æ‰¾åºåˆ—çš„é•¿åº¦</li>
<li>å¹³å‡æƒ…å†µï¼š$O(\log n)$ï¼Œå…¶ä¸­$n$æ˜¯æ ‘ä¸­çš„èŠ‚ç‚¹æ•°</li>
</ul>
<p><strong>Radix Treeçš„é«˜çº§å®ç°æŠ€æœ¯</strong>ï¼š</p>
<ol>
<li><strong>è‡ªé€‚åº”è·¯å¾„å‹ç¼©</strong>ï¼š
   æ ¹æ®è®¿é—®æ¨¡å¼åŠ¨æ€è°ƒæ•´å‹ç¼©ç­–ç•¥ï¼š</li>
</ol>
<pre class="codehilite"><code>function adaptive_compress(node):
    if node.access_frequency &gt; threshold:
        // é«˜é¢‘è®¿é—®èŠ‚ç‚¹ï¼Œä¿æŒè¾ƒçŸ­è·¯å¾„
        max_compress_length = 8
    else:
        // ä½é¢‘èŠ‚ç‚¹ï¼Œæœ€å¤§åŒ–å‹ç¼©
        max_compress_length = 64

    compress_path(node, max_compress_length)
</code></pre>

<ol start="2">
<li><strong>SIMDåŠ é€Ÿçš„å‰ç¼€åŒ¹é…</strong>ï¼š
   åˆ©ç”¨å‘é‡æŒ‡ä»¤åŠ é€Ÿtokenåºåˆ—æ¯”è¾ƒï¼š</li>
</ol>
<pre class="codehilite"><code>function simd_prefix_match(seq1, seq2, length):
    // ä½¿ç”¨AVX-512ä¸€æ¬¡æ¯”è¾ƒ16ä¸ªtokens
    for i in range(0, length, 16):
        mask = _mm512_cmpeq_epi32(seq1[i:i+16], seq2[i:i+16])
        if mask != 0xFFFF:
            return i + count_trailing_zeros(~mask)
    return length
</code></pre>

<ol start="3">
<li><strong>Copy-on-Writeä¼˜åŒ–</strong>ï¼š
   å»¶è¿Ÿå¤åˆ¶ç­–ç•¥å‡å°‘å†…å­˜åˆ†é…ï¼š</li>
</ol>
<pre class="codehilite"><code>function insert_with_cow(path, new_tokens):
    nodes_to_split = []
    current = root

    // æ ‡è®°éœ€è¦åˆ†è£‚çš„èŠ‚ç‚¹
    for node in path:
        if node.ref_count &gt; 1:
            nodes_to_split.append(node)

    // æ‰¹é‡æ‰§è¡Œåˆ†è£‚æ“ä½œ
    for node in nodes_to_split:
        new_node = shallow_copy(node)
        update_parent_pointer(new_node)
</code></pre>

<p><strong>å†…å­˜å¸ƒå±€ä¼˜åŒ–</strong>ï¼š</p>
<ol>
<li><strong>ç¼“å­˜è¡Œå¯¹é½</strong>ï¼š
   ç¡®ä¿çƒ­ç‚¹æ•°æ®åœ¨åŒä¸€ç¼“å­˜è¡Œï¼ˆ64å­—èŠ‚ï¼‰ï¼š</li>
</ol>
<pre class="codehilite"><code>struct RadixNode {
    // çƒ­æ•°æ®ï¼šå‰64å­—èŠ‚
    uint32_t ref_count;      // 4 bytes
    uint32_t prefix_len;     // 4 bytes
    Token prefix[14];        // 56 bytes (å‡è®¾Tokenæ˜¯4å­—èŠ‚)

    // å†·æ•°æ®ï¼šç‹¬ç«‹ç¼“å­˜è¡Œ
    void* kv_cache_ptr;      // 8 bytes
    Map* children;           // 8 bytes
    Timestamp last_access;   // 8 bytes
} __attribute__((aligned(64)));
</code></pre>

<ol start="2">
<li><strong>NUMAæ„ŸçŸ¥åˆ†é…</strong>ï¼š
   åœ¨å¤šNUMAèŠ‚ç‚¹ç³»ç»Ÿä¸Šä¼˜åŒ–å†…å­˜åˆ†é…ï¼š</li>
</ol>
<pre class="codehilite"><code>function numa_aware_allocate(size, access_pattern):
    if access_pattern == SEQUENTIAL:
        // äº¤é”™åˆ†é…åˆ°æ‰€æœ‰NUMAèŠ‚ç‚¹
        return interleaved_alloc(size)
    else:
        // æœ¬åœ°åˆ†é…
        return local_alloc(size, current_numa_node())
</code></pre>

<p><strong>å‹ç¼©æ•ˆç‡åˆ†æ</strong>ï¼š</p>
<p>å‡è®¾åŸå§‹Trieæœ‰$N$ä¸ªèŠ‚ç‚¹ï¼Œå¹³å‡åˆ†æ”¯å› å­ä¸º$b$ï¼Œå¹³å‡è·¯å¾„é•¿åº¦ä¸º$l$ã€‚</p>
<p>Radix Treeçš„èŠ‚ç‚¹æ•°æœŸæœ›å€¼ï¼š
$$E[N_{radix}] = N \times \frac{b-1}{b} \times \frac{1}{1 - (1/b)^l}$$
å‹ç¼©ç‡ï¼š
$$\text{Compression Ratio} = 1 - \frac{N_{radix}}{N} \approx 1 - \frac{b-1}{b \times (1 - (1/b)^l)}$$
å¯¹äºå…¸å‹çš„LLMåœºæ™¯ï¼ˆ$b \approx 50000$è¯è¡¨å¤§å°ï¼Œ$l \approx 100$å¹³å‡é•¿åº¦ï¼‰ï¼š
$$\text{Compression Ratio} \approx 1 - \frac{1}{100} = 99\%$$
<strong>æ·±å…¥çš„ç®—æ³•åˆ†æ</strong>ï¼š</p>
<ol>
<li><strong>åˆ†è£‚æ“ä½œçš„ä¼˜åŒ–</strong>ï¼š
   å½“æ’å…¥æ–°åºåˆ—å¯¼è‡´èŠ‚ç‚¹åˆ†è£‚æ—¶ï¼Œéœ€è¦æ‰¾åˆ°æœ€ä¼˜åˆ†è£‚ç‚¹ï¼š</li>
</ol>
<pre class="codehilite"><code>function find_split_point(node, new_sequence):
    // è®¡ç®—æœ€é•¿å…¬å…±å‰ç¼€
    lcp_length = compute_lcp(node.prefix, new_sequence)

    if lcp_length == len(node.prefix):
        // æ–°åºåˆ—æ˜¯å½“å‰å‰ç¼€çš„æ‰©å±•
        return NO_SPLIT
    elif lcp_length == 0:
        // å®Œå…¨ä¸åŒ¹é…ï¼Œéœ€è¦åœ¨çˆ¶èŠ‚ç‚¹å¤„ç†
        return PARENT_SPLIT
    else:
        // éƒ¨åˆ†åŒ¹é…ï¼Œåœ¨lcp_lengthå¤„åˆ†è£‚
        return lcp_length
</code></pre>

<ol start="2">
<li><strong>å¹¶å‘å®‰å…¨çš„æ›´æ–°</strong>ï¼š
   ä½¿ç”¨ç»†ç²’åº¦é”å’Œæ— é”ç®—æ³•æé«˜å¹¶å‘æ€§ï¼š</li>
</ol>
<pre class="codehilite"><code>function concurrent_insert(sequence, kv_data):
    version = atomic_load(tree_version)

    retry:
    path = find_insertion_path(sequence)

    // å°è¯•æ— é”æ’å…¥
    for node in path:
        if not try_lock(node):
            // é€€é¿é‡è¯•
            backoff()
            goto retry

    // éªŒè¯ç‰ˆæœ¬å·
    if atomic_load(tree_version) != version:
        unlock_all(path)
        goto retry

    // æ‰§è¡Œæ’å…¥
    perform_insertion(path, sequence, kv_data)
    atomic_increment(tree_version)
    unlock_all(path)
</code></pre>

<ol start="3">
<li><strong>å†…å­˜ç¢ç‰‡ç®¡ç†</strong>ï¼š
   ä½¿ç”¨slabåˆ†é…å™¨å‡å°‘ç¢ç‰‡ï¼š</li>
</ol>
<pre class="codehilite"><code>SlabAllocator {
    // ä¸åŒå¤§å°çš„slabæ± 
    small_slabs: Pool&lt;64B&gt;,    // çŸ­åºåˆ—èŠ‚ç‚¹
    medium_slabs: Pool&lt;256B&gt;,  // ä¸­ç­‰åºåˆ—
    large_slabs: Pool&lt;1KB&gt;,    // é•¿åºåˆ—
    huge_slabs: Pool&lt;4KB&gt;      // è¶…é•¿åºåˆ—
}

function allocate_node(prefix_length):
    size = sizeof(RadixNode) + prefix_length * sizeof(Token)

    if size &lt;= 64:
        return small_slabs.allocate()
    elif size &lt;= 256:
        return medium_slabs.allocate()
    elif size &lt;= 1024:
        return large_slabs.allocate()
    else:
        return huge_slabs.allocate()
</code></pre>

<p><strong>å®é™…å®ç°ä¸­çš„æƒè¡¡</strong>ï¼š</p>
<ol>
<li><strong>å‹ç¼©ç²’åº¦é€‰æ‹©</strong>ï¼š
   - æ¿€è¿›å‹ç¼©ï¼šæœ€å¤§åŒ–å†…å­˜èŠ‚çœï¼Œä½†å¢åŠ CPUå¼€é”€
   - ä¿å®ˆå‹ç¼©ï¼šå¹³è¡¡CPUå’Œå†…å­˜ï¼Œé€‚åˆé«˜QPSåœºæ™¯
   - è‡ªé€‚åº”å‹ç¼©ï¼šæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´</li>
</ol>
<p>å‹ç¼©é˜ˆå€¼å…¬å¼ï¼š
$$\text{Threshold} = \alpha \times \text{CPU_Load} + \beta \times \text{Memory_Pressure}$$
å…¶ä¸­$\alpha \approx -0.6$ï¼Œ$\beta \approx 0.4$ã€‚</p>
<ol start="2">
<li><strong>æ‰¹é‡æ“ä½œä¼˜åŒ–</strong>ï¼š
   æ‰¹é‡å¤„ç†å¤šä¸ªè¯·æ±‚çš„å‰ç¼€åŒ¹é…ï¼š</li>
</ol>
<pre class="codehilite"><code>function batch_prefix_match(requests):
    // æŒ‰å‰ç¼€é•¿åº¦æ’åºï¼Œæé«˜ç¼“å­˜å±€éƒ¨æ€§
    sorted_requests = sort_by_prefix_similarity(requests)

    results = []
    cache_hints = {}

    for request in sorted_requests:
        // åˆ©ç”¨å‰ä¸€ä¸ªè¯·æ±‚çš„è·¯å¾„ä¿¡æ¯
        hint = cache_hints.get(request.prefix[:8])
        match = find_match_with_hint(request, hint)

        // æ›´æ–°hintç¼“å­˜
        cache_hints[request.prefix[:8]] = match.path
        results.append(match)

    return results
</code></pre>

<ol start="3">
<li><strong>åŠ¨æ€é‡ç»„ç»‡</strong>ï¼š
   å®šæœŸé‡ç»„ç»‡æ ‘ç»“æ„ä»¥ç»´æŒæ€§èƒ½ï¼š</li>
</ol>
<pre class="codehilite"><code>function reorganize_tree():
    stats = collect_access_statistics()

    // è¯†åˆ«çƒ­ç‚¹è·¯å¾„
    hot_paths = identify_hot_paths(stats, top_k=100)

    // è§£å‹ç¼©çƒ­ç‚¹è·¯å¾„ä»¥å‡å°‘è®¿é—®å»¶è¿Ÿ
    for path in hot_paths:
        decompress_path(path)

    // å‹ç¼©å†·è·¯å¾„ä»¥èŠ‚çœå†…å­˜
    cold_paths = identify_cold_paths(stats, bottom_k=1000)
    for path in cold_paths:
        aggressive_compress(path)
</code></pre>

<p><strong>æ€§èƒ½ç‰¹å¾å¯¹æ¯”</strong>ï¼š</p>
<p>| ç‰¹æ€§ | Trie | Radix Tree | ä¼˜åŒ–åRadix Tree |</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Trie</th>
<th>Radix Tree</th>
<th>ä¼˜åŒ–åRadix Tree</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç©ºé—´å¤æ‚åº¦</td>
<td>O(NÃ—M)</td>
<td>O(NÃ—MÃ—(1-Ï))</td>
<td>O(NÃ—MÃ—(1-Ï)Ã—0.7)</td>
</tr>
<tr>
<td>æ’å…¥æ—¶é—´</td>
<td>O(M)</td>
<td>O(M)</td>
<td>O(MÃ—1.2)</td>
</tr>
<tr>
<td>æŸ¥æ‰¾æ—¶é—´</td>
<td>O(M)</td>
<td>O(min(M,logN))</td>
<td>O(min(M,logN)Ã—0.9)</td>
</tr>
<tr>
<td>ç¼“å­˜å‹å¥½æ€§</td>
<td>å·®</td>
<td>ä¸­ç­‰</td>
<td>å¥½</td>
</tr>
<tr>
<td>å¹¶å‘æ€§èƒ½</td>
<td>ä¸­ç­‰</td>
<td>å¥½</td>
<td>å¾ˆå¥½</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­Ïæ˜¯é‡å¤ç‡ï¼ŒMæ˜¯å¹³å‡åºåˆ—é•¿åº¦ï¼ŒNæ˜¯åºåˆ—æ•°é‡ã€‚</p>
<p><strong>å®é™…æ¡ˆä¾‹ï¼šSGLangçš„RadixAttention</strong>ï¼š</p>
<p>SGLangå®ç°äº†ä¸€ä¸ªé«˜åº¦ä¼˜åŒ–çš„RadixAttentionç³»ç»Ÿï¼š</p>
<ol>
<li>
<p><strong>å‰ç¼€å…±äº«ç»Ÿè®¡</strong>ï¼š
   - å¹³å‡å‰ç¼€é•¿åº¦ï¼š512 tokens
   - å…±äº«ç‡ï¼š85%çš„è¯·æ±‚å…±äº«&gt;50%çš„å‰ç¼€
   - å†…å­˜èŠ‚çœï¼š70-80%</p>
</li>
<li>
<p><strong>æ€§èƒ½æå‡</strong>ï¼š
   - é¦–tokenå»¶è¿Ÿé™ä½ï¼š3-5x
   - ååé‡æå‡ï¼š2-3x
   - å†…å­˜å¸¦å®½èŠ‚çœï¼š60%</p>
</li>
<li>
<p><strong>æ‰©å±•æ€§</strong>ï¼š
   - æ”¯æŒ100K+å¹¶å‘è¯·æ±‚
   - äºšæ¯«ç§’çº§çš„æ ‘æ“ä½œå»¶è¿Ÿ
   - è‡ªåŠ¨åƒåœ¾å›æ”¶ä¸å†…å­˜æ•´ç†</p>
</li>
</ol>
<p><strong>SGLangçš„å…³é”®åˆ›æ–°</strong>ï¼š</p>
<ol>
<li><strong>å‰ç¼€æ„ŸçŸ¥çš„è°ƒåº¦</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>function prefix_aware_scheduling(requests):
    // æ„å»ºå‰ç¼€ç›¸ä¼¼åº¦å›¾
    similarity_graph = build_similarity_graph(requests)

    // ä½¿ç”¨å›¾ç€è‰²ç®—æ³•åˆ†ç»„
    groups = graph_coloring(similarity_graph)

    // æŒ‰ç»„è°ƒåº¦ï¼Œæœ€å¤§åŒ–å‰ç¼€å¤ç”¨
    for group in groups:
        batch = select_compatible_requests(group)
        schedule_batch(batch)
</code></pre>

<ol start="2">
<li><strong>å¢é‡KVè®¡ç®—</strong>ï¼š
   åªè®¡ç®—æ–°å¢éƒ¨åˆ†çš„KVï¼Œé¿å…é‡å¤è®¡ç®—ï¼š</li>
</ol>
<pre class="codehilite"><code>function incremental_kv_compute(request, shared_prefix_length):
    // å¤ç”¨å·²æœ‰çš„KV Cache
    shared_kv = lookup_shared_kv(request.tokens[:shared_prefix_length])

    // åªè®¡ç®—æ–°å¢éƒ¨åˆ†
    new_tokens = request.tokens[shared_prefix_length:]
    new_kv = compute_kv(new_tokens, start_pos=shared_prefix_length)

    // ç»„åˆå¾—åˆ°å®Œæ•´KV
    full_kv = concatenate(shared_kv, new_kv)
    return full_kv
</code></pre>

<ol start="3">
<li><strong>å†…å­˜æ± ä¸é¢„åˆ†é…</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>MemoryPool {
    // åˆ†çº§å†…å­˜æ± 
    pools: {
        64: Queue&lt;Block64&gt;,    // 64 token blocks
        256: Queue&lt;Block256&gt;,  // 256 token blocks
        1024: Queue&lt;Block1024&gt; // 1024 token blocks
    }

    function allocate(size):
        // å‘ä¸Šå–æ•´åˆ°æœ€è¿‘çš„å—å¤§å°
        block_size = next_power_of_2(size)
        return pools[block_size].dequeue()
}
</code></pre>

<p><strong>Radix Treeåœ¨ä¸åŒç¡¬ä»¶ä¸Šçš„ä¼˜åŒ–</strong>ï¼š</p>
<ol>
<li><strong>GPUä¼˜åŒ–</strong>ï¼š
   - ä½¿ç”¨çº¹ç†å†…å­˜å­˜å‚¨æ ‘ç»“æ„ï¼Œåˆ©ç”¨ç¡¬ä»¶ç¼“å­˜
   - æ‰¹é‡æ ‘éå†ï¼Œæé«˜å¹¶è¡Œåº¦
   - Warpçº§åˆ«çš„åä½œéå†</li>
</ol>
<pre class="codehilite"><code>__global__ void batch_radix_lookup(
    RadixNode* tree,
    int* queries,
    int* results,
    int batch_size
) {
    int tid = blockIdx.x * blockDim.x + threadIdx.x;
    if (tid &gt;= batch_size) return;

    // Warpå†…åä½œéå†
    int warp_id = tid / 32;
    int lane_id = tid % 32;

    RadixNode* current = tree;
    int query = queries[tid];

    while (current != nullptr) {
        // Warpå†…å¹¶è¡Œæ¯”è¾ƒ
        int match = __ballot_sync(0xffffffff, 
            current-&gt;prefix[lane_id] == query_tokens[lane_id]);

        if (__popc(match) == 32) {
            // å®Œå…¨åŒ¹é…ï¼Œç»§ç»­æ·±å…¥
            current = current-&gt;children[query_next_token];
        } else {
            // éƒ¨åˆ†åŒ¹é…ï¼Œè®°å½•ç»“æœ
            break;
        }
    }

    results[tid] = current-&gt;node_id;
}
</code></pre>

<ol start="2">
<li><strong>CPUä¼˜åŒ–ï¼ˆAVX-512ï¼‰</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>void avx512_radix_match(
    const int32_t* prefix1,
    const int32_t* prefix2,
    int length,
    int* match_length
) {
    __m512i* vec1 = (__m512i*)prefix1;
    __m512i* vec2 = (__m512i*)prefix2;

    int i;
    for (i = 0; i &lt; length / 16; i++) {
        __mmask16 mask = _mm512_cmpeq_epi32_mask(vec1[i], vec2[i]);
        if (mask != 0xFFFF) {
            *match_length = i * 16 + __builtin_ctz(~mask);
            return;
        }
    }

    // å¤„ç†å‰©ä½™éƒ¨åˆ†
    *match_length = i * 16;
    for (int j = i * 16; j &lt; length; j++) {
        if (prefix1[j] != prefix2[j]) {
            *match_length = j;
            return;
        }
    }
    *match_length = length;
}
</code></pre>

<ol start="3">
<li><strong>ç§»åŠ¨è®¾å¤‡ä¼˜åŒ–ï¼ˆARM NEONï¼‰</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>void neon_radix_match(
    const int32_t* prefix1,
    const int32_t* prefix2,
    int length,
    int* match_length
) {
    int i = 0;

    // NEONä¸€æ¬¡å¤„ç†4ä¸ªint32
    for (; i + 4 &lt;= length; i += 4) {
        int32x4_t v1 = vld1q_s32(prefix1 + i);
        int32x4_t v2 = vld1q_s32(prefix2 + i);

        uint32x4_t cmp = vceqq_s32(v1, v2);
        uint64_t mask = vget_lane_u64(
            vreinterpret_u64_u32(vget_low_u32(cmp)), 0);

        if (mask != 0xFFFFFFFFFFFFFFFF) {
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸åŒ¹é…
            *match_length = i + __builtin_clzll(~mask) / 32;
            return;
        }
    }

    // æ ‡é‡å¤„ç†å‰©ä½™éƒ¨åˆ†
    for (; i &lt; length; i++) {
        if (prefix1[i] != prefix2[i]) {
            *match_length = i;
            return;
        }
    }
    *match_length = length;
}
</code></pre>

<p><strong>ç†è®ºåˆ†æï¼šRadix Treeçš„æ”¶æ•›æ€§</strong>ï¼š</p>
<p>ç»™å®šä¸€ä¸ªtokenåºåˆ—æµ$S = \{s_1, s_2, ..., s_n\}$ï¼Œå®šä¹‰å‰ç¼€åˆ†å¸ƒï¼š
$$P(prefix) = \frac{|\{s_i : prefix \sqsubseteq s_i\}|}{n}$$
Radix Treeçš„ç©ºé—´å¤æ‚åº¦æ”¶æ•›åˆ°ï¼š
$$\lim_{n \to \infty} \frac{\text{Space}(n)}{n} = H(P) + o(1)$$
å…¶ä¸­$H(P)$æ˜¯å‰ç¼€åˆ†å¸ƒçš„ç†µï¼š
$$H(P) = -\sum_{prefix} P(prefix) \log P(prefix)$$
è¿™è¡¨æ˜Radix Treeçš„ç©ºé—´æ•ˆç‡æ¥è¿‘ä¿¡æ¯è®ºä¸‹ç•Œã€‚</p>
<h3 id="1414-vllmpagedattention">14.1.4 vLLMçš„PagedAttentionæœºåˆ¶æ·±åº¦è§£æ</h3>
<p>vLLMå¼•å…¥çš„PagedAttentionæ˜¯ä¸€ä¸ªé©å‘½æ€§çš„KV Cacheç®¡ç†æœºåˆ¶ï¼Œå€Ÿé‰´äº†æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿå†…å­˜ç®¡ç†æ€æƒ³ã€‚</p>
<p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>ï¼š</p>
<ol>
<li><strong>ç‰©ç†å—ï¼ˆPhysical Blockï¼‰</strong>ï¼šå›ºå®šå¤§å°çš„å†…å­˜å—ï¼Œå­˜å‚¨å›ºå®šæ•°é‡tokençš„KV Cache</li>
<li><strong>é€»è¾‘å—ï¼ˆLogical Blockï¼‰</strong>ï¼šè¯·æ±‚çœ‹åˆ°çš„è¿ç»­åœ°å€ç©ºé—´</li>
<li><strong>å—è¡¨ï¼ˆBlock Tableï¼‰</strong>ï¼šé€»è¾‘å—åˆ°ç‰©ç†å—çš„æ˜ å°„</li>
</ol>
<p>æ•°å­¦å½¢å¼åŒ–ï¼š</p>
<ul>
<li>å—å¤§å°ï¼š$B$ tokens</li>
<li>ç‰©ç†å—é›†åˆï¼š$\mathcal{P} = \{p_1, p_2, ..., p_N\}$</li>
<li>æ˜ å°„å‡½æ•°ï¼š$f: \text{LogicalAddr} \rightarrow \text{PhysicalAddr}$</li>
</ul>
<p>å†…å­˜åˆ©ç”¨ç‡è®¡ç®—ï¼š
$$\text{Utilization} = \frac{\sum_{i=1}^{M} \lceil S_i / B \rceil \times B}{\text{Total Memory}} \times \frac{\sum_{i=1}^{M} S_i}{\sum_{i=1}^{M} \lceil S_i / B \rceil \times B}$$
å…¶ä¸­$S_i$æ˜¯ç¬¬$i$ä¸ªè¯·æ±‚çš„åºåˆ—é•¿åº¦ã€‚</p>
<p>PagedAttentionçš„æ³¨æ„åŠ›è®¡ç®—éœ€è¦ä¿®æ”¹ä¸ºï¼š
$$\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{Q \cdot \text{Gather}(K, \text{BlockTable})}{\sqrt{d_k}}\right) \cdot \text{Gather}(V, \text{BlockTable})$$
å…¶ä¸­Gatheræ“ä½œæ ¹æ®å—è¡¨ä»åˆ†æ•£çš„ç‰©ç†å—ä¸­æ”¶é›†KVå¼ é‡ã€‚</p>
<p><strong>PagedAttentionçš„è¯¦ç»†è®¾è®¡</strong>ï¼š</p>
<ol>
<li><strong>å—ç®¡ç†å™¨æ¶æ„</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>BlockManager {
    physical_blocks: List[PhysicalBlock],
    free_blocks: Queue[BlockID],
    block_tables: Map&lt;RequestID, List[BlockID]&gt;,
    block_size: int = 16,  // tokens per block
    ref_counts: Map&lt;BlockID, int&gt;
}
</code></pre>

<ol start="2">
<li><strong>å†…å­˜åˆ†é…ç®—æ³•</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>function allocate_blocks(request_id, num_tokens):
    num_blocks = ceil(num_tokens / block_size)
    allocated = []

    for i in range(num_blocks):
        if free_blocks.empty():
            // è§¦å‘å†…å­˜é©±é€
            evict_least_recently_used()

        block_id = free_blocks.pop()
        allocated.append(block_id)
        ref_counts[block_id] = 1

    block_tables[request_id] = allocated
    return allocated
</code></pre>

<ol start="3">
<li><strong>Copy-on-Writeå®ç°</strong>ï¼š
   å½“å¤šä¸ªè¯·æ±‚å…±äº«å‰ç¼€æ—¶ï¼Œä½¿ç”¨COWé¿å…é‡å¤å­˜å‚¨ï¼š</li>
</ol>
<pre class="codehilite"><code>function fork_blocks(parent_request, child_request, shared_length):
    shared_blocks = ceil(shared_length / block_size)
    parent_table = block_tables[parent_request]

    // å…±äº«å‰ç¼€å—
    child_table = parent_table[:shared_blocks].copy()
    for block_id in child_table:
        ref_counts[block_id] += 1

    block_tables[child_request] = child_table
</code></pre>

<p><strong>æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯</strong>ï¼š</p>
<ol>
<li><strong>å—å¤§å°é€‰æ‹©</strong>ï¼š
   æœ€ä¼˜å—å¤§å°é€šè¿‡æœ€å°åŒ–å†…éƒ¨ç¢ç‰‡å’Œå¤–éƒ¨ç¢ç‰‡ç¡®å®šï¼š</li>
</ol>
<p>å†…éƒ¨ç¢ç‰‡ï¼š
$$\text{Internal Fragmentation} = \sum_{i=1}^{M} (B - (S_i \bmod B)) \times \mathbb{1}[S_i \bmod B \neq 0]$$
å¤–éƒ¨ç¢ç‰‡ï¼š
$$\text{External Fragmentation} = \text{Total Memory} - \sum_{\text{allocated blocks}} B$$
å…¸å‹å€¼ï¼šB=16æˆ–B=32 tokens</p>
<ol start="2">
<li>
<p><strong>é¢„åˆ†é…ç­–ç•¥</strong>ï¼š
   æ ¹æ®è¯·æ±‚æ¨¡å¼é¢„æµ‹æœªæ¥éœ€æ±‚ï¼š
$$\text{Prealloc}_i = \text{Current}_i + \alpha \times \text{AvgGrowth} + \beta \times \text{StdGrowth}$$
å…¶ä¸­$\alpha \approx 1.0$ï¼Œ$\beta \approx 1.5$ä¿è¯95%ç½®ä¿¡åº¦ã€‚</p>
</li>
<li>
<p><strong>NUMAä¼˜åŒ–</strong>ï¼š
   åœ¨å¤šNUMAèŠ‚ç‚¹ç³»ç»Ÿä¸Šï¼Œæ ¹æ®GPUäº²å’Œæ€§åˆ†é…ï¼š</p>
</li>
</ol>
<pre class="codehilite"><code>function numa_aware_allocation(gpu_id):
    numa_node = get_numa_node(gpu_id)
    // ä¼˜å…ˆä»æœ¬åœ°NUMAèŠ‚ç‚¹åˆ†é…
    blocks = allocate_from_numa(numa_node, required_blocks)
    if blocks.size() &lt; required_blocks:
        // ä¸è¶³æ—¶ä»è¿œç¨‹èŠ‚ç‚¹åˆ†é…
        remote_blocks = allocate_remote(required_blocks - blocks.size())
        blocks.extend(remote_blocks)
    return blocks
</code></pre>

<p><strong>æ·±å…¥ç†è§£PagedAttentionçš„è®¾è®¡å“²å­¦</strong>ï¼š</p>
<ol>
<li>
<p><strong>ä¸ºä»€ä¹ˆé€‰æ‹©åˆ†é¡µæœºåˆ¶</strong>ï¼š
   - <strong>çµæ´»æ€§</strong>ï¼šåŠ¨æ€å¢é•¿ï¼Œæ— éœ€é¢„åˆ†é…æœ€å¤§é•¿åº¦
   - <strong>å…±äº«æ€§</strong>ï¼šç‰©ç†å—å¯åœ¨è¯·æ±‚é—´å…±äº«
   - <strong>ç¢ç‰‡æ§åˆ¶</strong>ï¼šå›ºå®šå—å¤§å°å‡å°‘å¤–éƒ¨ç¢ç‰‡
   - <strong>å¹¶å‘å‹å¥½</strong>ï¼šå—çº§åˆ«çš„ç»†ç²’åº¦ç®¡ç†</p>
</li>
<li>
<p><strong>ä¸æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜çš„ç±»æ¯”</strong>ï¼š</p>
</li>
</ol>
<p>| OSè™šæ‹Ÿå†…å­˜ | PagedAttention |</p>
<table>
<thead>
<tr>
<th>OSè™šæ‹Ÿå†…å­˜</th>
<th>PagedAttention</th>
</tr>
</thead>
<tbody>
<tr>
<td>é¡µé¢ï¼ˆPageï¼‰</td>
<td>å—ï¼ˆBlockï¼‰</td>
</tr>
<tr>
<td>é¡µè¡¨ï¼ˆPage Tableï¼‰</td>
<td>å—è¡¨ï¼ˆBlock Tableï¼‰</td>
</tr>
<tr>
<td>TLB</td>
<td>å—ç¼“å­˜</td>
</tr>
<tr>
<td>é¡µé¢ç½®æ¢</td>
<td>å—é©±é€</td>
</tr>
<tr>
<td>Copy-on-Write</td>
<td>å…±äº«å‰ç¼€COW</td>
</tr>
</tbody>
</table>
<ol start="3">
<li><strong>å†…å­˜å±‚æ¬¡ç»“æ„</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>GPU HBM (é«˜å¸¦å®½å†…å­˜)
â”œâ”€â”€ Active Blocks (æ´»è·ƒå—)
â”‚   â””â”€â”€ å½“å‰æ‰¹æ¬¡ä½¿ç”¨çš„KV Cache
â”œâ”€â”€ Cached Blocks (ç¼“å­˜å—)
â”‚   â””â”€â”€ æœ€è¿‘ä½¿ç”¨ä½†å½“å‰æœªæ¿€æ´»
â””â”€â”€ Swapped Blocks (äº¤æ¢å—)
    â””â”€â”€ ç§»åˆ°CPUå†…å­˜çš„å†·æ•°æ®
</code></pre>

<p><strong>é«˜çº§å†…å­˜ç®¡ç†ç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>å¤šçº§é©±é€ç­–ç•¥</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>function multi_level_eviction():
    // Level 1: é©±é€æœªå¼•ç”¨çš„å—
    for block in physical_blocks:
        if ref_counts[block.id] == 0:
            free_blocks.push(block.id)
            return

    // Level 2: LRUé©±é€
    lru_block = find_lru_block()
    if lru_block and not lru_block.pinned:
        swap_to_cpu(lru_block)
        free_blocks.push(lru_block.id)
        return

    // Level 3: ç´§æ€¥é©±é€ï¼ˆå¯èƒ½å½±å“æ€§èƒ½ï¼‰
    victim = select_victim_request()
    preempt_request(victim)
</code></pre>

<ol start="2">
<li><strong>é¢„æµ‹æ€§é¢„å–</strong>ï¼š
   åŸºäºæ³¨æ„åŠ›æ¨¡å¼é¢„æµ‹æœªæ¥è®¿é—®ï¼š</li>
</ol>
<pre class="codehilite"><code>function predictive_prefetch(current_position, attention_pattern):
    // åˆ†æå†å²æ³¨æ„åŠ›æ¨¡å¼
    future_positions = analyze_attention_pattern(attention_pattern)

    for pos in future_positions:
        if probability(pos) &gt; prefetch_threshold:
            block_id = position_to_block(pos)
            if is_swapped(block_id):
                async_fetch_from_cpu(block_id)
</code></pre>

<ol start="3">
<li><strong>è‡ªé€‚åº”å—å¤§å°</strong>ï¼š
   æ ¹æ®å·¥ä½œè´Ÿè½½åŠ¨æ€è°ƒæ•´ï¼š</li>
</ol>
<pre class="codehilite"><code>function adaptive_block_sizing(workload_stats):
    avg_seq_length = workload_stats.avg_sequence_length
    variance = workload_stats.length_variance

    if variance &lt; 0.2 * avg_seq_length:
        // é•¿åº¦é›†ä¸­ï¼Œä½¿ç”¨å¤§å—
        return 32
    elif avg_seq_length &lt; 512:
        // çŸ­åºåˆ—ï¼Œä½¿ç”¨å°å—
        return 8
    else:
        // é»˜è®¤ä¸­ç­‰å—å¤§å°
        return 16
</code></pre>

<p><strong>Gatheræ“ä½œçš„é«˜æ•ˆå®ç°</strong>ï¼š</p>
<ol>
<li><strong>å‘é‡åŒ–Gather</strong>ï¼š
   ä½¿ç”¨SIMDæŒ‡ä»¤åŠ é€Ÿæ•°æ®æ”¶é›†ï¼š</li>
</ol>
<pre class="codehilite"><code>function vectorized_gather(kv_cache, block_table, position):
    result = zeros(shape=[num_heads, head_dim])

    for i in range(0, len(block_table), 4):
        // AVX-512ä¸€æ¬¡åŠ è½½4ä¸ªå—
        blocks = _mm512_load_epi64(&amp;block_table[i])
        offsets = _mm512_add_epi64(blocks, position % block_size)

        // Gatheræ“ä½œ
        data = _mm512_i64gather_ps(offsets, kv_cache, 8)
        _mm512_store_ps(&amp;result[i * head_dim], data)

    return result
</code></pre>

<ol start="2">
<li>
<p><strong>æ‰¹é‡Gatherä¼˜åŒ–</strong>ï¼š
   å¯¹å¤šä¸ªè¯·æ±‚çš„Gatheræ“ä½œè¿›è¡Œåˆå¹¶ï¼š
$$\text{BatchGather}(\{Q_i\}, \{K_i\}, \{\text{Table}_i\}) = \text{Fused}(\bigcup_{i} \text{Gather}(K_i, \text{Table}_i))$$</p>
</li>
<li>
<p><strong>ç¼“å­˜é¢„å–</strong>ï¼š
   æ ¹æ®è®¿é—®æ¨¡å¼é¢„å–ä¸‹ä¸€ä¸ªå—ï¼š</p>
</li>
</ol>
<pre class="codehilite"><code>function prefetch_next_blocks(current_position, block_table):
    next_block_idx = (current_position + 1) // block_size
    if next_block_idx &lt; len(block_table):
        __builtin_prefetch(&amp;kv_cache[block_table[next_block_idx]], 0, 3)
</code></pre>

<p><strong>å®é™…æ•ˆæœåˆ†æ</strong>ï¼š</p>
<ol>
<li>
<p><strong>å†…å­˜èŠ‚çœ</strong>ï¼š
   - ä¼ ç»Ÿæ–¹æ³•ï¼šæ¯ä¸ªè¯·æ±‚é¢„åˆ†é…æœ€å¤§é•¿åº¦
   - PagedAttentionï¼šæŒ‰éœ€åˆ†é…ï¼ŒèŠ‚çœ60-80%å†…å­˜</p>
</li>
<li>
<p><strong>æ€§èƒ½å½±å“</strong>ï¼š
   - Gatherå¼€é”€ï¼š~5-10%é¢å¤–è®¡ç®—
   - å†…å­˜å¸¦å®½æå‡ï¼šæ›´å¥½çš„å±€éƒ¨æ€§
   - ç»¼åˆæ€§èƒ½ï¼šæå‡2-4xååé‡</p>
</li>
<li>
<p><strong>æ‰©å±•æ€§</strong>ï¼š
   - æ”¯æŒåŠ¨æ€batch size
   - é€‚åº”å˜é•¿åºåˆ—
   - é«˜æ•ˆçš„å†…å­˜å¤ç”¨</p>
</li>
</ol>
<h2 id="142-kv-cache">14.2 åŠ¨æ€KV Cacheå‹ç¼©æŠ€æœ¯</h2>
<p>åœ¨è¾¹ç¼˜è®¾å¤‡ä¸Šï¼ŒåŠ¨æ€å‹ç¼©KV Cacheæ˜¯å¹³è¡¡å†…å­˜ä½¿ç”¨å’Œæ¨¡å‹æ€§èƒ½çš„å…³é”®æŠ€æœ¯ã€‚ä¸é™æ€å‹ç¼©ä¸åŒï¼ŒåŠ¨æ€å‹ç¼©èƒ½å¤Ÿæ ¹æ®è¿è¡Œæ—¶çš„å†…å®¹é‡è¦æ€§å’Œå†…å­˜å‹åŠ›è‡ªé€‚åº”åœ°è°ƒæ•´å‹ç¼©ç­–ç•¥ã€‚</p>
<h3 id="1421-token">14.2.1 åŸºäºé‡è¦æ€§çš„Tokenå‰”é™¤ç­–ç•¥</h3>
<p>å¹¶éæ‰€æœ‰tokenå¯¹æœ€ç»ˆè¾“å‡ºçš„è´¡çŒ®éƒ½ç›¸åŒã€‚é€šè¿‡åˆ†ææ³¨æ„åŠ›æƒé‡ï¼Œæˆ‘ä»¬å¯ä»¥è¯†åˆ«å¹¶å‰”é™¤ä¸é‡è¦çš„tokenï¼Œä»è€Œå‹ç¼©KV Cacheã€‚</p>
<p>Tokené‡è¦æ€§è¯„åˆ†å¯ä»¥é€šè¿‡ç´¯ç§¯æ³¨æ„åŠ›æƒé‡è®¡ç®—ï¼š
$$\text{Importance}_i = \sum_{t=i}^{T} \sum_{h=1}^{H} \alpha_{t,i}^{(h)}$$
å…¶ä¸­$\alpha_{t,i}^{(h)}$æ˜¯ç¬¬$h$ä¸ªæ³¨æ„åŠ›å¤´åœ¨æ—¶é—´æ­¥$t$å¯¹ä½ç½®$i$çš„æ³¨æ„åŠ›æƒé‡ã€‚</p>
<p>å‰”é™¤ç­–ç•¥ï¼š</p>
<ol>
<li><strong>ç¡¬é˜ˆå€¼å‰”é™¤</strong>ï¼š$\text{Keep}_i = \mathbb{1}[\text{Importance}_i &gt; \theta]$</li>
<li><strong>Top-Kä¿ç•™</strong>ï¼šä¿ç•™é‡è¦æ€§æœ€é«˜çš„$K$ä¸ªtoken</li>
<li><strong>åŠ¨æ€é˜ˆå€¼</strong>ï¼š$\theta = \mu - \beta \cdot \sigma$ï¼Œå…¶ä¸­$\mu$å’Œ$\sigma$æ˜¯é‡è¦æ€§åˆ†æ•°çš„å‡å€¼å’Œæ ‡å‡†å·®</li>
</ol>
<p><strong>æ·±å…¥ç†è§£æ³¨æ„åŠ›æƒé‡çš„åˆ†å¸ƒç‰¹æ€§</strong>ï¼š</p>
<ol>
<li><strong>é•¿å°¾åˆ†å¸ƒç°è±¡</strong>ï¼š
   å¤§éƒ¨åˆ†æ³¨æ„åŠ›é›†ä¸­åœ¨å°‘æ•°tokenä¸Šã€‚ç ”ç©¶è¡¨æ˜ï¼Œé€šå¸¸å‰20%çš„tokenæ‰¿è½½äº†80%ä»¥ä¸Šçš„æ³¨æ„åŠ›æƒé‡ã€‚</li>
</ol>
<p>æ³¨æ„åŠ›åˆ†å¸ƒçš„å¸•ç´¯æ‰˜å®šå¾‹ï¼š
$$P(\text{Attention} &gt; x) \propto x^{-\alpha}$$
å…¶ä¸­$\alpha \approx 1.5-2.0$ã€‚</p>
<ol start="2">
<li>
<p><strong>ä½ç½®åå¥½æ¨¡å¼</strong>ï¼š
   - <strong>è¿‘æœŸåå¥½</strong>ï¼šæœ€è¿‘çš„tokené€šå¸¸è·å¾—æ›´é«˜æƒé‡
   - <strong>é¦–å°¾æ•ˆåº”</strong>ï¼šåºåˆ—å¼€å¤´å’Œç»“å°¾çš„tokenæ›´é‡è¦
   - <strong>è¯­ä¹‰å…³é”®ç‚¹</strong>ï¼šåè¯ã€åŠ¨è¯ç­‰å®è¯æ¯”è™šè¯é‡è¦</p>
</li>
<li>
<p><strong>å¤šå¤´æ³¨æ„åŠ›çš„å¼‚è´¨æ€§</strong>ï¼š
   ä¸åŒæ³¨æ„åŠ›å¤´å…³æ³¨ä¸åŒæ¨¡å¼ï¼š</p>
</li>
</ol>
<pre class="codehilite"><code>Head 1-4: å±€éƒ¨ä¾èµ–ï¼ˆç›¸é‚»è¯ï¼‰
Head 5-8: è¯­æ³•ç»“æ„ï¼ˆä¸»è°“å®¾ï¼‰
Head 9-12: é•¿è·ç¦»ä¾èµ–
Head 13-16: å…¨å±€ä¿¡æ¯
</code></pre>

<p><strong>æ”¹è¿›çš„é‡è¦æ€§è¯„åˆ†ç®—æ³•</strong>ï¼š</p>
<ol>
<li>
<p><strong>åŠ æƒé‡è¦æ€§åˆ†æ•°</strong>ï¼š
   è€ƒè™‘ä¸åŒå±‚çš„è´¡çŒ®å·®å¼‚ï¼š
$$\text{Importance}_i = \sum_{l=1}^{L} w_l \sum_{t=i}^{T} \sum_{h=1}^{H} \alpha_{t,i}^{(l,h)}$$
å…¶ä¸­$w_l$æ˜¯ç¬¬$l$å±‚çš„æƒé‡ï¼Œé€šå¸¸åæœŸå±‚æƒé‡æ›´é«˜ã€‚</p>
</li>
<li>
<p><strong>æ—¶é—´è¡°å‡å› å­</strong>ï¼š
   è€ƒè™‘tokençš„æ—¶é—´è·ç¦»ï¼š
$$\text{Importance}_i = \sum_{t=i}^{T} \exp(-\lambda(t-i)) \sum_{h=1}^{H} \alpha_{t,i}^{(h)}$$
å…¶ä¸­$\lambda$æ§åˆ¶è¡°å‡é€Ÿåº¦ï¼Œå…¸å‹å€¼$\lambda \approx 0.01$ã€‚</p>
</li>
<li>
<p><strong>ä¸Šä¸‹æ–‡æ„ŸçŸ¥è¯„åˆ†</strong>ï¼š
   ç»“åˆè¯­ä¹‰ä¿¡æ¯ï¼š
$$\text{Importance}_i = \text{Attention Score}_i \times \text{Semantic Weight}_i$$
å…¶ä¸­è¯­ä¹‰æƒé‡å¯ä»¥é€šè¿‡TF-IDFæˆ–è¯æ€§æ ‡æ³¨è·å¾—ã€‚</p>
</li>
</ol>
<p><strong>åŠ¨æ€å‰”é™¤ç®—æ³•å®ç°</strong>ï¼š</p>
<ol>
<li><strong>æ»‘åŠ¨çª—å£ç®—æ³•</strong>ï¼š</li>
</ol>
<pre class="codehilite"><code>function sliding_window_pruning(importance_scores, window_size=128):
    keep_mask = zeros(len(importance_scores))

    for i in range(0, len(importance_scores), window_size):
        window = importance_scores[i:i+window_size]
        threshold = percentile(window, keep_ratio * 100)
        keep_mask[i:i+window_size] = window &gt; threshold

    return keep_mask
</code></pre>

<ol start="2">
<li>
<p><strong>è‡ªé€‚åº”é˜ˆå€¼è°ƒæ•´</strong>ï¼š
   æ ¹æ®å†…å­˜å‹åŠ›åŠ¨æ€è°ƒæ•´ï¼š
$$\theta_{t+1} = \theta_t \times \left(\frac{\text{Memory Used}}{\text{Memory Target}}\right)^{\gamma}$$
å…¶ä¸­$\gamma \approx 2$æä¾›éçº¿æ€§è°ƒæ•´ã€‚</p>
</li>
<li>
<p><strong>åˆ†å±‚å‰”é™¤ç­–ç•¥</strong>ï¼š
   ä¸åŒå±‚ä½¿ç”¨ä¸åŒå‰”é™¤ç‡ï¼š</p>
</li>
</ol>
<pre class="codehilite"><code>pruning_rates = {
    &quot;early_layers&quot;: 0.7,    # å‰1/3å±‚ï¼Œä¿ç•™70%
    &quot;middle_layers&quot;: 0.85,  # ä¸­é—´1/3å±‚ï¼Œä¿ç•™85%
    &quot;late_layers&quot;: 0.95     # å1/3å±‚ï¼Œä¿ç•™95%
}
</code></pre>

<p><strong>å®éªŒç»“æœä¸åˆ†æ</strong>ï¼š</p>
<ol>
<li>
<p><strong>å†…å­˜èŠ‚çœ vs æ€§èƒ½æŸå¤±</strong>ï¼š
   - ä¿ç•™50% tokensï¼šPPLå¢åŠ &lt;5%ï¼Œå†…å­˜èŠ‚çœ50%
   - ä¿ç•™30% tokensï¼šPPLå¢åŠ &lt;15%ï¼Œå†…å­˜èŠ‚çœ70%
   - ä¿ç•™20% tokensï¼šPPLå¢åŠ &lt;30%ï¼Œå†…å­˜èŠ‚çœ80%</p>
</li>
<li>
<p><strong>ä»»åŠ¡æ•æ„Ÿæ€§</strong>ï¼š
   - é—®ç­”ä»»åŠ¡ï¼šå¯¹å‰”é™¤æ•æ„Ÿï¼Œéœ€ä¿ç•™70%+
   - æ‘˜è¦ä»»åŠ¡ï¼šä¸­ç­‰æ•æ„Ÿï¼Œå¯ä¿ç•™50%
   - ç¿»è¯‘ä»»åŠ¡ï¼šè¾ƒä¸æ•æ„Ÿï¼Œå¯ä¿ç•™40%</p>
</li>
<li>
<p><strong>æ¨¡å‹è§„æ¨¡å½±å“</strong>ï¼š
   - å°æ¨¡å‹ï¼ˆ&lt;3Bï¼‰ï¼šå¯¹å‰”é™¤æ•æ„Ÿ
   - ä¸­æ¨¡å‹ï¼ˆ3-13Bï¼‰ï¼šé€‚åº¦å‰”é™¤å¯æ¥å—
   - å¤§æ¨¡å‹ï¼ˆ&gt;13Bï¼‰ï¼šå¯æ‰¿å—æ›´æ¿€è¿›å‰”é™¤</p>
</li>
</ol>
<h3 id="1422-h2oheavy-hitter-oracle">14.2.2 H2Oï¼ˆHeavy Hitter Oracleï¼‰ç®—æ³•åŸç†</h3>
<p>H2Oç®—æ³•åŸºäº"é‡å‡»è€…"ï¼ˆHeavy Hitterï¼‰çš„æ¦‚å¿µï¼Œè¯†åˆ«åœ¨æ³¨æ„åŠ›è®¡ç®—ä¸­é¢‘ç¹è¢«è®¿é—®çš„KVå¯¹ã€‚</p>
<p>ç®—æ³•æ ¸å¿ƒæ­¥éª¤ï¼š</p>
<ol>
<li><strong>ç»Ÿè®¡è®¿é—®é¢‘ç‡</strong>ï¼šç»´æŠ¤æ¯ä¸ªKVå¯¹çš„è®¿é—®è®¡æ•°</li>
<li><strong>è¯†åˆ«Heavy Hitter</strong>ï¼šä½¿ç”¨Count-Min Sketchæ•°æ®ç»“æ„é«˜æ•ˆç»Ÿè®¡</li>
<li><strong>åŠ¨æ€è°ƒæ•´</strong>ï¼šæ ¹æ®è®¿é—®æ¨¡å¼å®æ—¶æ›´æ–°ä¿ç•™é›†åˆ</li>
</ol>
<p>Count-Min Sketchçš„æ•°å­¦æè¿°ï¼š</p>
<ul>
<li>å“ˆå¸Œå‡½æ•°æ—ï¼š$\{h_1, h_2, ..., h_d\}$</li>
<li>è®¡æ•°çŸ©é˜µï¼š$C \in \mathbb{R}^{d \times w}$</li>
<li>é¢‘ç‡ä¼°è®¡ï¼š$\hat{f}(x) = \min_{i=1}^{d} C[i, h_i(x)]$</li>
</ul>
<p>ç©ºé—´å¤æ‚åº¦ï¼š$O(d \times w)$ï¼Œè¿œå°äºç›´æ¥å­˜å‚¨æ‰€æœ‰è®¡æ•°çš„$O(n)$ã€‚</p>
<p>H2Oçš„ä¿ç•™æ¦‚ç‡æ¨¡å‹ï¼š
$$P(\text{keep}_i) = \min\left(1, \frac{\hat{f}(i)}{\theta \cdot \text{avg}(f)}\right)$$</p>
<h3 id="1423-scissorhandskv-cache">14.2.3 Scissorhandsï¼šè‡ªé€‚åº”KV Cacheå‰ªæ</h3>
<p>Scissorhandsæå‡ºäº†ä¸€ç§åŸºäº"å…³é”®-æŸ¥è¯¢"åŒ¹é…åº¦çš„è‡ªé€‚åº”å‰ªææ–¹æ³•ã€‚æ ¸å¿ƒè§‚å¯Ÿæ˜¯ï¼šä¸æ˜¯æ‰€æœ‰å†å²KVå¯¹éƒ½ä¸å½“å‰æŸ¥è¯¢ç›¸å…³ã€‚</p>
<p>åŒ¹é…åº¦è®¡ç®—ï¼š
$$\text{Relevance}_{i,t} = \frac{\exp(q_t \cdot k_i / \sqrt{d})}{\sum_{j \in \text{Window}} \exp(q_t \cdot k_j / \sqrt{d})}$$
å‰ªæå†³ç­–é€šè¿‡æ»‘åŠ¨çª—å£å†…çš„ç´¯ç§¯ç›¸å…³æ€§ï¼š
$$\text{Score}_i = \sum_{t \in \text{Window}} \text{Relevance}_{i,t} \cdot \exp(-\lambda \cdot |t - t_i|)$$
å…¶ä¸­$\lambda$æ˜¯æ—¶é—´è¡°å‡å› å­ï¼Œ$t_i$æ˜¯token $i$çš„ç”Ÿæˆæ—¶é—´ã€‚</p>
<p>è‡ªé€‚åº”é˜ˆå€¼é€šè¿‡åœ¨çº¿å­¦ä¹ è°ƒæ•´ï¼š
$$\theta_{t+1} = \theta_t + \alpha \cdot (\text{PPL}_t - \text{PPL}_{\text{target}})$$
å…¶ä¸­PPLæ˜¯å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰ï¼Œç”¨äºè¡¡é‡å‰ªæå¯¹æ¨¡å‹è´¨é‡çš„å½±å“ã€‚</p>
<h3 id="1424-streamingllmattention">14.2.4 StreamingLLMçš„æ»‘åŠ¨çª—å£attention</h3>
<p>StreamingLLMæå‡ºäº†ä¸€ç§ç®€å•ä½†æœ‰æ•ˆçš„æ–¹æ³•ï¼šä¿ç•™åˆå§‹çš„å‡ ä¸ª"é”šç‚¹"tokenå’Œæœ€è¿‘çš„çª—å£ã€‚</p>
<p>æ•°å­¦å½¢å¼åŒ–ï¼š</p>
<ul>
<li>é”šç‚¹é›†åˆï¼š$\mathcal{A} = \{1, 2, ..., n_{\text{anchor}}\}$</li>
<li>æ»‘åŠ¨çª—å£ï¼š$\mathcal{W} = \{t - w + 1, ..., t\}$</li>
<li>ä¿ç•™é›†åˆï¼š$\mathcal{K} = \mathcal{A} \cup \mathcal{W}$</li>
</ul>
<p>æ³¨æ„åŠ›è®¡ç®—ä¿®æ”¹ä¸ºï¼š
$$\alpha_{i,j} = \begin{cases}
\frac{\exp(q_i \cdot k_j / \sqrt{d})}{\sum_{k \in \mathcal{K}} \exp(q_i \cdot k_k / \sqrt{d})} &amp; \text{if } j \in \mathcal{K} \\
0 &amp; \text{otherwise}
\end{cases}$$
å†…å­˜å ç”¨ä»$O(T)$é™ä½åˆ°$O(n_{\text{anchor}} + w)$ï¼Œå…¶ä¸­$T$æ˜¯æ€»åºåˆ—é•¿åº¦ã€‚</p>
<p>ç†è®ºåˆ†æè¡¨æ˜ï¼Œé”šç‚¹tokençš„ä½œç”¨ç±»ä¼¼äº"æ³¨æ„åŠ›æ±‡èšç‚¹"ï¼ˆattention sinkï¼‰ï¼Œé˜²æ­¢æ³¨æ„åŠ›åˆ†å¸ƒè¿‡äºåˆ†æ•£ã€‚</p>
<h2 id="143-kv-cache">14.3 é‡åŒ–KV Cacheå­˜å‚¨</h2>
<h3 id="1431-kv-cache">14.3.1 KV Cacheé‡åŒ–çš„ç†è®ºåŸºç¡€</h3>
<p>KV Cacheçš„é‡åŒ–å¯ä»¥æ˜¾è‘—å‡å°‘å†…å­˜å ç”¨ï¼Œä½†éœ€è¦ä»”ç»†å¹³è¡¡ç²¾åº¦æŸå¤±ã€‚ä¸æƒé‡é‡åŒ–ä¸åŒï¼ŒKV Cacheé‡åŒ–é¢ä¸´çš„æŒ‘æˆ˜åŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>åŠ¨æ€èŒƒå›´å˜åŒ–</strong>ï¼šä¸åŒå±‚ã€ä¸åŒä½ç½®çš„KVå€¼èŒƒå›´å·®å¼‚å¤§</li>
<li><strong>ç´¯ç§¯è¯¯å·®</strong>ï¼šé‡åŒ–è¯¯å·®ä¼šåœ¨è‡ªå›å½’ç”Ÿæˆä¸­ç´¯ç§¯</li>
<li><strong>æ³¨æ„åŠ›æ•æ„Ÿæ€§</strong>ï¼šå¾®å°çš„KVå€¼å˜åŒ–å¯èƒ½å¯¼è‡´æ³¨æ„åŠ›åˆ†å¸ƒå‰§å˜</li>
</ol>
<p>é‡åŒ–å‡½æ•°çš„ä¸€èˆ¬å½¢å¼ï¼š
$$\text{Quantize}(x) = \text{clip}\left(\text{round}\left(\frac{x - z}{s}\right), q_{\min}, q_{\max}\right)$$
å…¶ä¸­$s$æ˜¯ç¼©æ”¾å› å­ï¼Œ$z$æ˜¯é›¶ç‚¹ï¼Œ$[q_{\min}, q_{\max}]$æ˜¯é‡åŒ–èŒƒå›´ã€‚</p>
<p>åé‡åŒ–ï¼š
$$\text{Dequantize}(q) = s \cdot q + z$$</p>
<h3 id="1432-vs">14.3.2 å¯¹ç§°vséå¯¹ç§°é‡åŒ–ç­–ç•¥</h3>
<p><strong>å¯¹ç§°é‡åŒ–</strong>ï¼š</p>
<ul>
<li>é›¶ç‚¹å›ºå®šä¸º0ï¼š$z = 0$</li>
<li>ç¼©æ”¾å› å­ï¼š$s = \frac{\max(|x|)}{2^{b-1} - 1}$ï¼Œå…¶ä¸­$b$æ˜¯æ¯”ç‰¹æ•°</li>
<li>ä¼˜ç‚¹ï¼šè®¡ç®—ç®€å•ï¼Œç¡¬ä»¶å‹å¥½</li>
<li>ç¼ºç‚¹ï¼šå¯¹äºåæ–œåˆ†å¸ƒæ•ˆç‡ä½</li>
</ul>
<p><strong>éå¯¹ç§°é‡åŒ–</strong>ï¼š</p>
<ul>
<li>é›¶ç‚¹ï¼š$z = q_{\min} - \frac{x_{\min}}{s}$</li>
<li>ç¼©æ”¾å› å­ï¼š$s = \frac{x_{\max} - x_{\min}}{q_{\max} - q_{\min}}$</li>
<li>ä¼˜ç‚¹ï¼šæ›´å¥½åœ°åˆ©ç”¨é‡åŒ–èŒƒå›´</li>
<li>ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–å­˜å‚¨é›¶ç‚¹</li>
</ul>
<p>é‡åŒ–è¯¯å·®åˆ†æï¼š
$$\mathbb{E}[\epsilon^2] = \frac{s^2}{12}$$
å…¶ä¸­$\epsilon = x - \text{Dequantize}(\text{Quantize}(x))$æ˜¯é‡åŒ–è¯¯å·®ã€‚</p>
<h3 id="1433">14.3.3 åˆ†ç»„é‡åŒ–ä¸æ··åˆç²¾åº¦ç­–ç•¥</h3>
<p><strong>åˆ†ç»„é‡åŒ–</strong>ï¼š
å°†KVå¼ é‡åˆ’åˆ†ä¸ºå¤šä¸ªç»„ï¼Œæ¯ç»„ä½¿ç”¨ç‹¬ç«‹çš„é‡åŒ–å‚æ•°ï¼š
$$\text{GroupQuant}(X) = \bigcup_{g=1}^{G} \text{Quantize}(X_g, s_g, z_g)$$
ç»„å¤§å°é€‰æ‹©çš„æƒè¡¡ï¼š</p>
<ul>
<li>å°ç»„ï¼šæ›´å¥½çš„ç²¾åº¦ï¼Œæ›´å¤šçš„å…ƒæ•°æ®å¼€é”€</li>
<li>å¤§ç»„ï¼šæ›´å°‘çš„å…ƒæ•°æ®ï¼Œå¯èƒ½çš„ç²¾åº¦æŸå¤±</li>
</ul>
<p>æœ€ä¼˜ç»„å¤§å°é€šè¿‡æœ€å°åŒ–æ€»è¯¯å·®ç¡®å®šï¼š
$$G^* = \arg\min_G \left[\sum_{g=1}^{G} \text{MSE}(X_g, \hat{X}_g) + \lambda \cdot G \cdot \text{MetadataSize}\right]$$
<strong>æ··åˆç²¾åº¦ç­–ç•¥</strong>ï¼š
ä¸åŒå±‚ä½¿ç”¨ä¸åŒçš„é‡åŒ–æ¯”ç‰¹æ•°ã€‚åŸºäºHessiançš„é‡è¦æ€§è¯„åˆ†ï¼š
$$\text{Importance}_l = \text{tr}(H_l) \cdot |\Delta W_l|_2^2$$
å…¶ä¸­$H_l$æ˜¯ç¬¬$l$å±‚çš„HessiançŸ©é˜µã€‚</p>
<p>æ¯”ç‰¹åˆ†é…ä¼˜åŒ–é—®é¢˜ï¼š
$$\min_{b_1, ..., b_L} \sum_{l=1}^{L} \text{Importance}_l \cdot \epsilon_l(b_l) \quad \text{s.t.} \sum_{l=1}^{L} b_l \cdot \text{Size}_l \leq \text{Budget}$$</p>
<h3 id="1434-int8int4-kv-cache">14.3.4 INT8/INT4 KV Cacheå®ç°ç»†èŠ‚</h3>
<p><strong>INT8é‡åŒ–æµç¨‹</strong>ï¼š</p>
<ol>
<li>æ”¶é›†æ ¡å‡†æ•°æ®çš„KVç»Ÿè®¡ä¿¡æ¯</li>
<li>è®¡ç®—æ¯å±‚çš„é‡åŒ–å‚æ•°</li>
<li>åœ¨çº¿é‡åŒ–æ–°ç”Ÿæˆçš„KV</li>
<li>æ³¨æ„åŠ›è®¡ç®—æ—¶åé‡åŒ–</li>
</ol>
<p>INT8æ³¨æ„åŠ›è®¡ç®—ä¼˜åŒ–ï¼š
$$\text{Attention}_{int8} = \text{softmax}\left(\frac{Q_{fp16} \cdot (s_K \cdot K_{int8} + z_K)}{\sqrt{d}}\right) \cdot (s_V \cdot V_{int8} + z_V)$$
å¯ä»¥é‡å†™ä¸ºï¼š
$$\text{Attention}_{int8} = s_V \cdot \text{softmax}\left(\frac{Q_{fp16} \cdot K_{int8} \cdot s_K}{\sqrt{d}} + \text{bias}\right) \cdot V_{int8} + \text{offset}$$
å…¶ä¸­biaså’Œoffseté¡¹å¯ä»¥é¢„è®¡ç®—ã€‚</p>
<p><strong>INT4é‡åŒ–çš„æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ol>
<li><strong>é‡åŒ–ç²’åº¦</strong>ï¼šæ¯16ä¸ªå…ƒç´ å…±äº«é‡åŒ–å‚æ•°</li>
<li><strong>æŸ¥æ‰¾è¡¨ä¼˜åŒ–</strong>ï¼šé¢„è®¡ç®—$2^4 = 16$ä¸ªå¯èƒ½çš„åé‡åŒ–å€¼</li>
<li><strong>å‘é‡åŒ–å®ç°</strong>ï¼šåˆ©ç”¨SIMDæŒ‡ä»¤åŠ é€Ÿ</li>
</ol>
<p>æ€§èƒ½åˆ†æï¼š</p>
<ul>
<li>å†…å­˜å¸¦å®½èŠ‚çœï¼š75%ï¼ˆç›¸æ¯”FP16ï¼‰</li>
<li>è®¡ç®—å¼€é”€ï¼š~10%çš„é¢å¤–åé‡åŒ–æˆæœ¬</li>
<li>ç«¯åˆ°ç«¯åŠ é€Ÿï¼š1.5-2xï¼ˆå†…å­˜å—é™åœºæ™¯ï¼‰</li>
</ul>
<h2 id="144-cache">14.4 è·¨è¯·æ±‚Cacheå¤ç”¨ç­–ç•¥</h2>
<h3 id="1441">14.4.1 ç³»ç»Ÿæç¤ºè¯çš„é«˜æ•ˆç®¡ç†</h3>
<p>åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œè®¸å¤šåº”ç”¨ä½¿ç”¨ç›¸åŒçš„ç³»ç»Ÿæç¤ºè¯ã€‚é«˜æ•ˆçš„å¤ç”¨ç­–ç•¥å¯ä»¥å¤§å¹…å‡å°‘å†…å­˜å ç”¨ã€‚</p>
<p><strong>Prompt Registryè®¾è®¡</strong>ï¼š
ç»´æŠ¤ä¸€ä¸ªå…¨å±€çš„æç¤ºè¯æ³¨å†Œè¡¨ï¼š</p>
<pre class="codehilite"><code>Registry {
    prompts: Map&lt;Hash, CacheEntry&gt;
    lru_queue: Queue&lt;Hash&gt;
    total_size: int
}
</code></pre>

<p>Hashè®¡ç®—è€ƒè™‘tokenåºåˆ—çš„è¯­ä¹‰ï¼š
$$\text{Hash}(tokens) = \text{SHA256}(\text{concat}(tokens) || \text{model_id})$$
<strong>ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ï¼š</p>
<ol>
<li><strong>å¼•ç”¨è®¡æ•°</strong>ï¼šè¿½è¸ªæ¯ä¸ªCacheçš„æ´»è·ƒä½¿ç”¨è€…</li>
<li><strong>TTLæœºåˆ¶</strong>ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè‡ªåŠ¨æ¸…ç†</li>
<li><strong>ä¼˜å…ˆçº§é˜Ÿåˆ—</strong>ï¼šåŸºäºä½¿ç”¨é¢‘ç‡å’Œé‡è¦æ€§æ’åº</li>
</ol>
<p>ç¼“å­˜å‘½ä¸­ç‡æ¨¡å‹ï¼š
$$P(\text{hit}) = 1 - e^{-\lambda \cdot t}$$
å…¶ä¸­$\lambda$æ˜¯è¯·æ±‚åˆ°è¾¾ç‡ï¼Œ$t$æ˜¯ç¼“å­˜å¤§å°ã€‚</p>
<h3 id="1442-multi-tenant">14.4.2 Multi-tenantåœºæ™¯ä¸‹çš„éš”ç¦»ä¸å…±äº«</h3>
<p>åœ¨å¤šç§Ÿæˆ·ç¯å¢ƒä¸­ï¼Œéœ€è¦å¹³è¡¡éš”ç¦»æ€§å’Œå…±äº«æ•ˆç‡ï¼š</p>
<p><strong>éš”ç¦»çº§åˆ«</strong>ï¼š</p>
<ol>
<li><strong>å®Œå…¨éš”ç¦»</strong>ï¼šæ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹çš„Cacheç©ºé—´</li>
<li><strong>éƒ¨åˆ†å…±äº«</strong>ï¼šå…±äº«å…¬å…±æç¤ºè¯ï¼Œéš”ç¦»ç§æœ‰å†…å®¹</li>
<li><strong>å®Œå…¨å…±äº«</strong>ï¼šæ‰€æœ‰ç§Ÿæˆ·å…±äº«åŒä¸€Cacheæ± </li>
</ol>
<p>èµ„æºåˆ†é…ç­–ç•¥é€šè¿‡è§£å†³ä¼˜åŒ–é—®é¢˜ï¼š
$$\max \sum_{i=1}^{N} U_i(m_i) \quad \text{s.t.} \sum_{i=1}^{N} m_i \leq M$$
å…¶ä¸­$U_i$æ˜¯ç§Ÿæˆ·$i$çš„æ•ˆç”¨å‡½æ•°ï¼Œ$m_i$æ˜¯åˆ†é…çš„å†…å­˜ï¼Œ$M$æ˜¯æ€»å†…å­˜ã€‚</p>
<p>å…¬å¹³æ€§çº¦æŸï¼š
$$\frac{m_i / r_i}{m_j / r_j} \geq \alpha, \quad \forall i,j$$
å…¶ä¸­$r_i$æ˜¯ç§Ÿæˆ·$i$çš„è¯·æ±‚ç‡ï¼Œ$\alpha \in [0,1]$æ˜¯å…¬å¹³æ€§å‚æ•°ã€‚</p>
<h3 id="1443-cache">14.4.3 Cacheé¢„çƒ­ä¸é¢„æµ‹æ€§åŠ è½½</h3>
<p><strong>é¢„çƒ­ç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>å†·å¯åŠ¨é¢„çƒ­</strong>ï¼šç³»ç»Ÿå¯åŠ¨æ—¶åŠ è½½é«˜é¢‘æç¤ºè¯</li>
<li><strong>å‘¨æœŸæ€§é¢„çƒ­</strong>ï¼šæ ¹æ®å†å²æ¨¡å¼é¢„åŠ è½½</li>
<li><strong>è‡ªé€‚åº”é¢„çƒ­</strong>ï¼šåŸºäºå®æ—¶ç›‘æ§åŠ¨æ€è°ƒæ•´</li>
</ol>
<p>é¢„æµ‹æ¨¡å‹ä½¿ç”¨æ—¶é—´åºåˆ—åˆ†æï¼š
$$\hat{f}_{t+1} = \alpha \cdot f_t + (1-\alpha) \cdot \hat{f}_t$$
å…¶ä¸­$f_t$æ˜¯æ—¶åˆ»$t$çš„å®é™…é¢‘ç‡ï¼Œ$\alpha$æ˜¯å¹³æ»‘å‚æ•°ã€‚</p>
<p><strong>é¢„å–æ”¶ç›Šåˆ†æ</strong>ï¼š
é¢„å–çš„æœŸæœ›æ”¶ç›Šï¼š
$$\text{Benefit} = P(\text{use}) \cdot \text{LatencySaved} - (1-P(\text{use})) \cdot \text{MemoryCost}$$
æœ€ä¼˜é¢„å–é˜ˆå€¼ï¼š
$$P^*(\text{use}) = \frac{\text{MemoryCost}}{\text{LatencySaved} + \text{MemoryCost}}$$</p>
<h3 id="1444-cache">14.4.4 åˆ†å¸ƒå¼CacheååŒæœºåˆ¶</h3>
<p>åœ¨å¤šèŠ‚ç‚¹éƒ¨ç½²åœºæ™¯ä¸‹ï¼ŒCacheçš„åˆ†å¸ƒå¼ç®¡ç†æˆä¸ºå…³é”®ï¼š</p>
<p><strong>ä¸€è‡´æ€§å“ˆå¸Œ</strong>ï¼š
ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œå°†Cacheåˆ†å¸ƒåˆ°ä¸åŒèŠ‚ç‚¹ï¼š
$$\text{Node}(key) = \arg\min_{n \in \text{Nodes}} \text{distance}(\text{hash}(key), \text{hash}(n))$$
<strong>Cacheè¿ç§»ç­–ç•¥</strong>ï¼š
å½“èŠ‚ç‚¹åŠ å…¥/ç¦»å¼€æ—¶ï¼Œæœ€å°åŒ–è¿ç§»æˆæœ¬ï¼š
$$\text{Migration} = \sum_{k \in \text{Keys}} \mathbb{1}[\text{Node}_{\text{old}}(k) \neq \text{Node}_{\text{new}}(k)] \cdot \text{Size}(k)$$
<strong>åˆ†å¸ƒå¼é©±é€ç®—æ³•</strong>ï¼š
å…¨å±€LRUçš„è¿‘ä¼¼å®ç°ï¼š</p>
<ol>
<li>æœ¬åœ°LRU + å…¨å±€æ—¶é’Ÿ</li>
<li>å‘¨æœŸæ€§åŒæ­¥æ—¶é—´æˆ³</li>
<li>åŸºäºæ¦‚ç‡çš„å…¨å±€é©±é€</li>
</ol>
<p>æ”¶æ•›æ€§ä¿è¯ï¼š
$$\lim_{t \to \infty} P(\text{Cache}_{\text{dist}} = \text{Cache}_{\text{global}}) = 1 - \epsilon$$</p>
<p>å…¶ä¸­$\epsilon$ä¸åŒæ­¥é¢‘ç‡å’Œç½‘ç»œå»¶è¿Ÿç›¸å…³ã€‚</p>
<h2 id="_1">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« ç³»ç»Ÿåœ°æ¢è®¨äº†KV Cacheç®¡ç†ä¸å‹ç¼©çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œè¿™äº›æŠ€æœ¯å¯¹äºåœ¨è¾¹ç¼˜è®¾å¤‡ä¸Šé«˜æ•ˆéƒ¨ç½²å¤§è¯­è¨€æ¨¡å‹è‡³å…³é‡è¦ã€‚</p>
<p><strong>å…³é”®è¦ç‚¹</strong>ï¼š</p>
<ol>
<li>
<p><strong>å‰ç¼€æ ‘ç®¡ç†</strong>ï¼šé€šè¿‡Trieå’ŒRadix Treeç»“æ„å®ç°KV Cacheçš„å…±äº«å­˜å‚¨ï¼Œå¯ä»¥èŠ‚çœé«˜è¾¾90%ä»¥ä¸Šçš„å†…å­˜ã€‚vLLMçš„PagedAttentionæœºåˆ¶å€Ÿé‰´æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜æ€æƒ³ï¼Œå®ç°äº†ç»†ç²’åº¦çš„å†…å­˜ç®¡ç†ã€‚</p>
</li>
<li>
<p><strong>åŠ¨æ€å‹ç¼©æŠ€æœ¯</strong>ï¼š
   - åŸºäºæ³¨æ„åŠ›æƒé‡çš„é‡è¦æ€§è¯„åˆ†ï¼š$\text{Importance}_i = \sum_{t=i}^{T} \sum_{h=1}^{H} \alpha_{t,i}^{(h)}$
   - H2Oç®—æ³•ä½¿ç”¨Count-Min Sketché«˜æ•ˆè¯†åˆ«é«˜é¢‘è®¿é—®çš„KVå¯¹
   - StreamingLLMé€šè¿‡ä¿ç•™é”šç‚¹tokenå’Œæ»‘åŠ¨çª—å£ï¼Œå°†å†…å­˜å¤æ‚åº¦ä»$O(T)$é™è‡³$O(n_{\text{anchor}} + w)$</p>
</li>
<li>
<p><strong>é‡åŒ–å­˜å‚¨</strong>ï¼š
   - INT8/INT4é‡åŒ–å¯èŠ‚çœ50%-75%çš„å†…å­˜
   - åˆ†ç»„é‡åŒ–é€šè¿‡ä¼˜åŒ–é—®é¢˜$G^* = \arg\min_G [\sum_{g=1}^{G} \text{MSE}(X_g, \hat{X}_g) + \lambda \cdot G \cdot \text{MetadataSize}]$å¹³è¡¡ç²¾åº¦å’Œå¼€é”€
   - æ··åˆç²¾åº¦ç­–ç•¥åŸºäºHessiané‡è¦æ€§è¯„åˆ†ä¼˜åŒ–æ¯”ç‰¹åˆ†é…</p>
</li>
<li>
<p><strong>è·¨è¯·æ±‚å¤ç”¨</strong>ï¼š
   - ç³»ç»Ÿæç¤ºè¯çš„å…¨å±€æ³¨å†Œè¡¨ç®¡ç†
   - å¤šç§Ÿæˆ·åœºæ™¯ä¸‹çš„èµ„æºåˆ†é…ä¼˜åŒ–ï¼š$\max \sum_{i=1}^{N} U_i(m_i)$ s.t. $\sum_{i=1}^{N} m_i \leq M$
   - åˆ†å¸ƒå¼CacheååŒé€šè¿‡ä¸€è‡´æ€§å“ˆå¸Œå®ç°è´Ÿè½½å‡è¡¡</p>
</li>
</ol>
<p><strong>å®è·µå»ºè®®</strong>ï¼š</p>
<ul>
<li>å¯¹äºèŠå¤©æœºå™¨äººç­‰å…±äº«å¤§é‡ç³»ç»Ÿæç¤ºçš„åœºæ™¯ï¼Œä¼˜å…ˆè€ƒè™‘å‰ç¼€æ ‘ç®¡ç†</li>
<li>é•¿æ–‡æœ¬ç”Ÿæˆä»»åŠ¡é€‚åˆä½¿ç”¨StreamingLLMç­‰æ»‘åŠ¨çª—å£æ–¹æ³•</li>
<li>å†…å­˜æåº¦å—é™çš„è¾¹ç¼˜è®¾å¤‡åº”ç»¼åˆä½¿ç”¨é‡åŒ–å’ŒåŠ¨æ€å‹ç¼©æŠ€æœ¯</li>
<li>å¤šç”¨æˆ·æœåŠ¡éœ€è¦ä»”ç»†è®¾è®¡ç¼“å­˜å¤ç”¨ç­–ç•¥ï¼Œå¹³è¡¡æ€§èƒ½å’Œå…¬å¹³æ€§</li>
</ul>
<h2 id="_2">ç»ƒä¹ é¢˜</h2>
<h3 id="_3">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>KV Cacheå†…å­˜è®¡ç®—</strong>
   ä¸€ä¸ªæ¨¡å‹æœ‰24å±‚ï¼Œ16ä¸ªæ³¨æ„åŠ›å¤´ï¼Œæ¯ä¸ªå¤´ç»´åº¦ä¸º64ã€‚è‹¥è¦å¤„ç†4096é•¿åº¦çš„åºåˆ—ï¼Œä½¿ç”¨FP16å­˜å‚¨ï¼Œè®¡ç®—æ‰€éœ€çš„KV Cacheå†…å­˜å¤§å°ã€‚</li>
</ol>
<p><em>æç¤ºï¼šä½¿ç”¨å…¬å¼$\text{Memory}_{KV} = 2 \times L \times H \times S \times D \times \text{dtype_size}$</em></p>
<ol start="2">
<li><strong>å‰ç¼€æ ‘èŠ‚çœç‡</strong>
   æœ‰100ä¸ªè¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚åŒ…å«1024ä¸ªtokençš„ç³»ç»Ÿæç¤ºå’Œå¹³å‡128ä¸ªtokençš„ç”¨æˆ·è¾“å…¥ã€‚å¦‚æœæ‰€æœ‰è¯·æ±‚å…±äº«ç›¸åŒçš„ç³»ç»Ÿæç¤ºï¼Œä½¿ç”¨å‰ç¼€æ ‘å¯ä»¥èŠ‚çœå¤šå°‘å†…å­˜ï¼Ÿ</li>
</ol>
<p><em>æç¤ºï¼šè®¡ç®—å…±äº«å‰åçš„æ€»tokenæ•°</em></p>
<ol start="3">
<li><strong>é‡åŒ–è¯¯å·®åˆ†æ</strong>
   ç»™å®šä¸€ä¸ªèŒƒå›´åœ¨[-2.0, 2.0]çš„å¼ é‡ï¼Œä½¿ç”¨INT8å¯¹ç§°é‡åŒ–ã€‚è®¡ç®—ç¼©æ”¾å› å­$s$å’Œæœ€å¤§é‡åŒ–è¯¯å·®ã€‚</li>
</ol>
<p><em>æç¤ºï¼šå¯¹ç§°é‡åŒ–ä¸­$s = \frac{\max(|x|)}{2^{b-1} - 1}$</em></p>
<ol start="4">
<li><strong>æ»‘åŠ¨çª—å£å†…å­˜å ç”¨</strong>
   StreamingLLMä½¿ç”¨4ä¸ªé”šç‚¹tokenå’Œçª—å£å¤§å°ä¸º512ã€‚å¯¹äº8192é•¿åº¦çš„åºåˆ—ï¼Œç›¸æ¯”å®Œæ•´KV CacheèŠ‚çœäº†å¤šå°‘å†…å­˜ï¼Ÿ</li>
</ol>
<p><em>æç¤ºï¼šæ¯”è¾ƒ$O(T)$å’Œ$O(n_{\text{anchor}} + w)$</em></p>
<h3 id="_4">æŒ‘æˆ˜é¢˜</h3>
<ol start="5">
<li><strong>PagedAttentionä¼˜åŒ–åˆ†æ</strong>
   è€ƒè™‘å—å¤§å°ä¸º16çš„PagedAttentionç³»ç»Ÿã€‚ç»™å®šåºåˆ—é•¿åº¦åˆ†å¸ƒä¸ºï¼š50%çš„è¯·æ±‚ä¸º100-200 tokensï¼Œ30%ä¸º500-600 tokensï¼Œ20%ä¸º1000-1100 tokensã€‚è®¡ç®—å†…å­˜æµªè´¹ç‡å’Œæœ€ä¼˜å—å¤§å°ã€‚</li>
</ol>
<p><em>æç¤ºï¼šå†…å­˜æµªè´¹æ¥è‡ªäºæœ€åä¸€ä¸ªä¸å®Œæ•´çš„å—</em></p>
<ol start="6">
<li><strong>å¤šç§Ÿæˆ·èµ„æºåˆ†é…</strong>
   ä¸‰ä¸ªç§Ÿæˆ·çš„è¯·æ±‚ç‡åˆ†åˆ«ä¸º$r_1=10$, $r_2=20$, $r_3=30$è¯·æ±‚/ç§’ï¼Œæ•ˆç”¨å‡½æ•°ä¸º$U_i(m) = \log(1 + m)$ã€‚æ€»å†…å­˜ä¸º100GBï¼Œå…¬å¹³æ€§å‚æ•°$\alpha=0.8$ã€‚æ±‚è§£æœ€ä¼˜å†…å­˜åˆ†é…ã€‚</li>
</ol>
<p><em>æç¤ºï¼šæ„å»ºæ‹‰æ ¼æœ—æ—¥å‡½æ•°æ±‚è§£çº¦æŸä¼˜åŒ–é—®é¢˜</em></p>
<ol start="7">
<li><strong>å‹ç¼©ç®—æ³•é€‰æ‹©</strong>
   ç»™å®šä¸€ä¸ªæ³¨æ„åŠ›æ¨¡å¼ï¼Œå…¶ä¸­90%çš„æ³¨æ„åŠ›é›†ä¸­åœ¨æœ€è¿‘çš„100ä¸ªtokenå’Œå‰10ä¸ªtokenä¸Šã€‚è®¾è®¡ä¸€ä¸ªç»“åˆH2Oå’ŒStreamingLLMæ€æƒ³çš„æ··åˆå‹ç¼©ç­–ç•¥ï¼Œå¹¶åˆ†æå…¶æ€§èƒ½ã€‚</li>
</ol>
<p><em>æç¤ºï¼šè€ƒè™‘ä¸åŒä½ç½®tokençš„é‡è¦æ€§åˆ†å¸ƒ</em></p>
<ol start="8">
<li><strong>åˆ†å¸ƒå¼Cacheä¸€è‡´æ€§</strong>
   è®¾è®¡ä¸€ä¸ªç®—æ³•ï¼Œåœ¨ç½‘ç»œåˆ†åŒºæƒ…å†µä¸‹ä¿è¯Cacheçš„æœ€ç»ˆä¸€è‡´æ€§ã€‚è€ƒè™‘3ä¸ªèŠ‚ç‚¹ï¼Œç½‘ç»œåˆ†åŒºæ¦‚ç‡ä¸º0.01ï¼ŒåŒæ­¥é—´éš”ä¸º100msã€‚åˆ†ææ”¶æ•›æ—¶é—´å’Œä¸€è‡´æ€§ä¿è¯ã€‚</li>
</ol>
<p><em>æç¤ºï¼šä½¿ç”¨å‘é‡æ—¶é’Ÿæˆ–CRDTæ•°æ®ç»“æ„</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<ol>
<li>
<p>Memory = 2 Ã— 24 Ã— 16 Ã— 4096 Ã— 64 Ã— 2 = 402,653,184 bytes â‰ˆ 384 MB</p>
</li>
<li>
<p>ä¸ä½¿ç”¨å‰ç¼€æ ‘ï¼š100 Ã— (1024 + 128) = 115,200 tokens
   ä½¿ç”¨å‰ç¼€æ ‘ï¼š1024 + 100 Ã— 128 = 13,824 tokens
   èŠ‚çœç‡ï¼š(115,200 - 13,824) / 115,200 = 88%</p>
</li>
<li>
<p>s = 2.0 / (127) â‰ˆ 0.0157
   æœ€å¤§é‡åŒ–è¯¯å·® = s/2 â‰ˆ 0.0079</p>
</li>
<li>
<p>å®Œæ•´Cacheï¼š8192 tokens
   StreamingLLMï¼š4 + 512 = 516 tokens
   èŠ‚çœç‡ï¼š(8192 - 516) / 8192 = 93.7%</p>
</li>
<li>
<p>å†…å­˜æµªè´¹ç‡è®¡ç®—ï¼š
   - 100-200 tokensï¼šå¹³å‡æµªè´¹ (16 - 150%16) = 10 tokens per request
   - 500-600 tokensï¼šå¹³å‡æµªè´¹ (16 - 550%16) = 10 tokens per request<br />
   - 1000-1100 tokensï¼šå¹³å‡æµªè´¹ (16 - 1050%16) = 6 tokens per request
   åŠ æƒå¹³å‡æµªè´¹ç‡ï¼šçº¦8.8%</p>
</li>
<li>
<p>æ„å»ºæ‹‰æ ¼æœ—æ—¥å‡½æ•°ï¼Œè€ƒè™‘KKTæ¡ä»¶ï¼š
   æœ€ä¼˜è§£çº¦ä¸ºï¼šmâ‚ â‰ˆ 20GB, mâ‚‚ â‰ˆ 33GB, mâ‚ƒ â‰ˆ 47GB</p>
</li>
<li>
<p>æ··åˆç­–ç•¥ï¼š
   - ä¿ç•™å‰10ä¸ªtokenä½œä¸ºé”šç‚¹ï¼ˆç±»ä¼¼StreamingLLMï¼‰
   - æœ€è¿‘100ä¸ªtokenå®Œæ•´ä¿ç•™
   - ä¸­é—´éƒ¨åˆ†ä½¿ç”¨H2OåŠ¨æ€é€‰æ‹©top-20%
   - é¢„æœŸå‹ç¼©ç‡ï¼š~85%ï¼ŒåŒæ—¶ä¿æŒ&gt;95%çš„ç”Ÿæˆè´¨é‡</p>
</li>
<li>
<p>ä½¿ç”¨å‘é‡æ—¶é’Ÿå®ç°ï¼š
   - æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤æœ¬åœ°ç‰ˆæœ¬å‘é‡
   - åˆ†åŒºæ—¶å„è‡ªç‹¬ç«‹æ›´æ–°
   - åˆå¹¶æ—¶ä½¿ç”¨max(v1, v2)è§£å†³å†²çª
   - æœŸæœ›æ”¶æ•›æ—¶é—´ï¼šO(log N Ã— sync_interval) â‰ˆ 200ms</p>
</li>
</ol>
</details>
            </article>
            
            <nav class="page-nav"><a href="chapter13.html" class="nav-link prev">â† ç¬¬13ç« ï¼šæ³¨æ„åŠ›æœºåˆ¶ä¼˜åŒ–</a><a href="chapter15.html" class="nav-link next">ç¬¬15ç« ï¼šè§£ç åŠ é€ŸæŠ€æœ¯ â†’</a></nav>
        </main>
    </div>
</body>
</html>